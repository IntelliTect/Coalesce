on:
  workflow_call:
    inputs:
      COALESCE_VERSION:
        required: true
        type: string

jobs:
  build-dotnet:
    runs-on: ubuntu-latest

    env:
      COALESCE_VERSION: ${{inputs.COALESCE_VERSION}}

    steps:
      - uses: actions/checkout@v4
      - name: Setup dotnet
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            8.0.x
            9.0.x

      - run: npm ci
      - run: dotnet restore
      - run: dotnet build --no-restore --configuration Release /WarnAsError
      - run: dotnet test --no-build --configuration Release
      - run: dotnet pack --no-build --configuration Release -p:PackageOutputPath="$(pwd)/out/packages"

      - name: "Upload Artifact: NuGet Packages"
        uses: actions/upload-artifact@v4
        with:
          name: packages
          path: out/packages

  validate-vue3-playground:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: playground/Coalesce.Web.Vue3

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            8.0.x
            9.0.x

      - run: npm ci
        working-directory: ${{ github.workspace }}

      - run: npm run coalesce
      - run: npm run build
      - run: dotnet build --configuration Release

  build-coalesce-vue:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: src/coalesce-vue

    env:
      COALESCE_VERSION: ${{inputs.COALESCE_VERSION}}

    steps:
      - uses: actions/checkout@v4

      - run: npm ci
        working-directory: ${{ github.workspace }}

      - name: npm run test
        run: npm run test -- --coverage --reporter=default --reporter=junit --outputFile coalesce-vue.results.xml

      # Currently broken with vitest: https://github.com/dorny/test-reporter/issues/187
      # - name: Publish Test Results
      #   uses: dorny/test-reporter@v1
      #   if: always() && github.event_name != 'pull_request'
      #   with:
      #     name: coalesce-vue tests
      #     path: '**/*.results.xml'
      #     reporter: jest-junit

      - name: update version
        run: sed -i "s/0.1.0-local/$COALESCE_VERSION/g" package.json

      - run: npm pack

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: coalesce-vue
          path: src/coalesce-vue/coalesce-vue*.tgz

  build-coalesce-vue-vuetify3:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: src/coalesce-vue-vuetify3

    env:
      COALESCE_VERSION: ${{inputs.COALESCE_VERSION}}

    steps:
      - uses: actions/checkout@v4

      - run: npm ci
        working-directory: ${{ github.workspace }}

      - run: npm run build-local-deps # build coalesce-vue
      - run: npm run build
      - run: npm run test

      - name: update version
        run: sed -i "s/0.1.0-local/$COALESCE_VERSION/g" package.json

      - run: npm pack

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: coalesce-vue-vuetify3
          path: src/coalesce-vue-vuetify3/*.tgz
