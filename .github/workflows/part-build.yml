on:
  workflow_call:
    inputs:
      COALESCE_VERSION:
        required: true
        type: string

jobs:
  build-dotnet:
    runs-on: ubuntu-latest

    env:
      COALESCE_VERSION: ${{inputs.COALESCE_VERSION}}

    steps:
      - uses: actions/checkout@v5
      - name: Setup dotnet
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: |
            8.0.x
            9.0.x

      - run: npm ci
      - run: dotnet restore
      - run: dotnet build --no-restore --configuration Release /WarnAsError
      - run: dotnet test --no-build --configuration Release
      - run: dotnet pack --no-build --configuration Release -p:PackageOutputPath="$(pwd)/out/packages"

      - name: "Upload Artifact: NuGet Packages"
        uses: actions/upload-artifact@v4
        with:
          name: packages
          path: out/packages

  validate-vue3-playground:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: playground/Coalesce.Web.Vue3

    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-dotnet@v5
        with:
          dotnet-version: |
            8.0.x
            9.0.x

      - run: npm ci
        working-directory: ${{ github.workspace }}

      - run: npm run coalesce
      - run: npm run build
      - run: dotnet build --configuration Release

  build-coalesce-vue:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: src/coalesce-vue

    env:
      COALESCE_VERSION: ${{inputs.COALESCE_VERSION}}

    steps:
      - uses: actions/checkout@v5

      - run: npm ci
        working-directory: ${{ github.workspace }}

      - name: npm run test
        run: npm run test -- --coverage --reporter=default --reporter=junit --outputFile coalesce-vue.results.xml

      # Currently broken with vitest: https://github.com/dorny/test-reporter/issues/187
      # - name: Publish Test Results
      #   uses: dorny/test-reporter@v1
      #   if: always() && github.event_name != 'pull_request'
      #   with:
      #     name: coalesce-vue tests
      #     path: '**/*.results.xml'
      #     reporter: jest-junit

      - name: update version
        run: sed -i "s/0.1.0-local/$COALESCE_VERSION/g" package.json

      - run: npm pack

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: coalesce-vue
          path: src/coalesce-vue/coalesce-vue*.tgz

  build-coalesce-mcp:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: src/coalesce-mcp

    env:
      COALESCE_VERSION: ${{inputs.COALESCE_VERSION}}

    steps:
      - uses: actions/checkout@v5

      - run: npm ci
        working-directory: ${{ github.workspace }}

      - name: npm run test
        run: npm run test

      - run: npm run build

      - name: update version
        run: sed -i "s/0.1.0-local/$COALESCE_VERSION/g" package.json

      - run: npm pack

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: coalesce-mcp
          path: src/coalesce-mcp/*.tgz

  build-coalesce-vue-vuetify3:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: src/coalesce-vue-vuetify3

    env:
      COALESCE_VERSION: ${{inputs.COALESCE_VERSION}}

    steps:
      - uses: actions/checkout@v5

      - run: npm ci
        working-directory: ${{ github.workspace }}

      - run: npm run build-local-deps # build coalesce-vue
      - run: npm run build
      - run: npm run test

      - name: update version
        run: sed -i "s/0.1.0-local/$COALESCE_VERSION/g" package.json

      - run: npm pack

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: coalesce-vue-vuetify3
          path: src/coalesce-vue-vuetify3/*.tgz

  build-docs:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
        working-directory: docs

    steps:
      - uses: actions/checkout@v5
        with:
          # fetch all commits to get last updated time or other git log info
          fetch-depth: 0

      - run: npm ci
        working-directory: ${{ github.workspace }}

      - name: Build docs
        run: npm run build

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: docs
          path: docs/.vitepress/dist/Coalesce

  validate-template:
    runs-on: ubuntu-latest
    name: "test template: ${{matrix.testCase}}"
    needs: [build-dotnet, build-coalesce-vue, build-coalesce-vue-vuetify3]
    strategy:
      matrix:
        testCase:
          # Nothing:
          - ""
          # Everything (except tenancy):
          - "--Identity --MicrosoftAuth --GoogleAuth --UserPictures --AuditLogs --ExampleModel --DarkMode --TrackingBase --AppInsights --OpenAPI --Hangfire --AIChat"
          # Assorted partial variants:
          - "--Identity --UserPictures --TrackingBase"
          - "--Identity --MicrosoftAuth --AuditLogs --Hangfire"
          # Tenancy variants:
          - "--Identity --Tenancy --TenantCreateExternal --GoogleAuth"
          - "--Identity --Tenancy --TenantCreateSelf --TenantMemberInvites --AuditLogs --LocalAuth --EmailSendGrid"
          - "--Identity --Tenancy --TenantCreateAdmin --TenantMemberInvites --MicrosoftAuth --LocalAuth --EmailAzure"

    defaults:
      run:
        shell: pwsh
        working-directory: ./templates/Coalesce.Vue.Template

    env:
      COALESCE_VERSION: ${{ inputs.COALESCE_VERSION }}

    steps:
      - uses: actions/checkout@v5

      - name: Setup dotnet
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: |
            8.0.x
            9.0.x

      - name: Download Artifacts
        uses: actions/download-artifact@v5
        with:
          path: ${{ github.workspace }}/artifacts

      - name: Add local nuget source
        run: |
          dotnet nuget add source "${{ github.workspace }}/artifacts/packages" --name "local-nuget"

      # Install the coalesce packages that we just built so we can validate the template against them.
      - name: "Install newly built Coalesce packages"
        run: |
          $ErrorActionPreference = "Stop"
          $PSNativeCommandUseErrorActionPreference = $true

          echo $env:COALESCE_VERSION
          ls ${{ github.workspace }}/artifacts -alR

          $filePath = "./content/Directory.Build.props"
          $newVersion = "<CoalesceVersion>$env:COALESCE_VERSION</CoalesceVersion>"
          (Get-Content $filePath) -replace '<CoalesceVersion>.*?<\/CoalesceVersion>', $newVersion | Set-Content $filePath 

          cat $filePath

          cd ./content/*.Web

          # Update package.json to use the newly built packages
          $coalescevuePath = "file:$((Get-ChildItem -Path '${{ github.workspace }}/artifacts/coalesce-vue/*.tgz').FullName)"
          $coalescevuetifyPath = "file:$((Get-ChildItem -Path '${{ github.workspace }}/artifacts/coalesce-vue-vuetify3/*.tgz').FullName)"

          $packageJson = Get-Content package.json | ConvertFrom-Json
          $packageJson.dependencies.'coalesce-vue' = $coalescevuePath
          $packageJson.dependencies.'coalesce-vue-vuetify3' = $coalescevuetifyPath
          $packageJson | ConvertTo-Json -Depth 10 | Set-Content package.json

          cat package.json

      - name: TestLocal
        run: ./TestLocal.ps1 "${{ matrix.testCase }}"
