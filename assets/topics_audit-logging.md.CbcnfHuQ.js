import{_ as s,c as a,o as n,a7 as e}from"./chunks/framework.BkavzUpE.js";const u=JSON.parse('{"title":"Audit Logging","description":"","frontmatter":{},"headers":[],"relativePath":"topics/audit-logging.md","filePath":"topics/audit-logging.md"}'),o={name:"topics/audit-logging.md"},l=e(`<h1 id="audit-logging" tabindex="-1">Audit Logging <a class="header-anchor" href="#audit-logging" aria-label="Permalink to &quot;Audit Logging&quot;">​</a></h1><p>Keeping a history of all (or most) of the changes that are made to records in your database can be invaluable, both for <a href="https://csrc.nist.gov/glossary/term/non_repudiation" target="_blank" rel="noreferrer">non-repudiation</a> (i.e. proving what happened and who did it), and for troubleshooting or debugging.</p><p>Coalesce provides a package <code>IntelliTect.Coalesce.AuditLogging</code> that adds an easy way to inject this kind of audit logging into your EF Core <code>DbContext</code>. It also includes an out-of-the-box view <a href="/Coalesce/stacks/vue/coalesce-vue-vuetify/components/c-admin-audit-log-page.html"><code>c-admin-audit-log-page</code></a> that enables browsing of this data on the frontend.</p><h2 id="setup" tabindex="-1">Setup <a class="header-anchor" href="#setup" aria-label="Permalink to &quot;Setup&quot;">​</a></h2><p>In this setup process, we&#39;re going to add an additional Coalesce Nuget package, define a custom entity to hold our audit logs, install the audit logging extension into our <code>DbContext</code>, and add a pre-made interface on the frontend to view our logs.</p><h3 id="_1-add-the-nuget-package" tabindex="-1">1. Add the NuGet package <a class="header-anchor" href="#_1-add-the-nuget-package" aria-label="Permalink to &quot;1. Add the NuGet package&quot;">​</a></h3><p>Add a reference to the Nuget package <code>IntelliTect.Coalesce.AuditLogging</code> to your data project:</p><div class="language-xml"><button title="Copy Code" class="copy"></button><span class="lang">xml</span><pre class="shiki dark-plus vp-code"><code><span class="line"><span style="color:#808080;">&lt;</span><span style="color:#569CD6;">ItemGroup</span><span style="color:#808080;">&gt;</span></span>
<span class="line"><span style="color:#808080;">  &lt;</span><span style="color:#569CD6;">PackageReference</span><span style="color:#9CDCFE;"> Include</span><span style="color:#D4D4D4;">=</span><span style="color:#CE9178;">&quot;IntelliTect.Coalesce&quot;</span><span style="color:#9CDCFE;"> Version</span><span style="color:#D4D4D4;">=</span><span style="color:#CE9178;">&quot;$(CoalesceVersion)&quot;</span><span style="color:#808080;"> /&gt;</span></span>
<span class="line highlighted"><span style="color:#808080;">  &lt;</span><span style="color:#569CD6;">PackageReference</span><span style="color:#9CDCFE;"> Include</span><span style="color:#D4D4D4;">=</span><span style="color:#CE9178;">&quot;IntelliTect.Coalesce.AuditLogging&quot;</span><span style="color:#9CDCFE;"> Version</span><span style="color:#D4D4D4;">=</span><span style="color:#CE9178;">&quot;$(CoalesceVersion)&quot;</span><span style="color:#808080;"> /&gt;</span></span>
<span class="line"><span style="color:#808080;">&lt;/</span><span style="color:#569CD6;">ItemGroup</span><span style="color:#808080;">&gt;</span></span></code></pre></div><h3 id="_2-define-the-log-entity" tabindex="-1">2. Define the log entity <a class="header-anchor" href="#_2-define-the-log-entity" aria-label="Permalink to &quot;2. Define the log entity&quot;">​</a></h3><p>Define the entity type that will hold the audit records in your database:</p><div class="language-c#"><button title="Copy Code" class="copy"></button><span class="lang">c#</span><pre class="shiki dark-plus vp-code"><code><span class="line"><span style="color:#C586C0;">using</span><span style="color:#4EC9B0;"> IntelliTect</span><span style="color:#D4D4D4;">.</span><span style="color:#4EC9B0;">Coalesce</span><span style="color:#D4D4D4;">.</span><span style="color:#4EC9B0;">AuditLogging</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">[</span><span style="color:#4EC9B0;">Read</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">Roles</span><span style="color:#D4D4D4;"> = </span><span style="color:#CE9178;">&quot;Administrator&quot;</span><span style="color:#D4D4D4;">)]</span></span>
<span class="line"><span style="color:#569CD6;">public</span><span style="color:#569CD6;"> class</span><span style="color:#4EC9B0;"> AuditLog</span><span style="color:#D4D4D4;"> : </span><span style="color:#4EC9B0;">DefaultAuditLog</span></span>
<span class="line"><span style="color:#D4D4D4;">{</span></span>
<span class="line"><span style="color:#569CD6;">    public</span><span style="color:#569CD6;"> string</span><span style="color:#D4D4D4;">? </span><span style="color:#9CDCFE;">UserId</span><span style="color:#D4D4D4;"> { </span><span style="color:#569CD6;">get</span><span style="color:#D4D4D4;">; </span><span style="color:#569CD6;">set</span><span style="color:#D4D4D4;">; }</span></span>
<span class="line"><span style="color:#569CD6;">    public</span><span style="color:#4EC9B0;"> AppUser</span><span style="color:#D4D4D4;">? </span><span style="color:#9CDCFE;">User</span><span style="color:#D4D4D4;"> { </span><span style="color:#569CD6;">get</span><span style="color:#D4D4D4;">; </span><span style="color:#569CD6;">set</span><span style="color:#D4D4D4;">; }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;">    // Other custom props as desired</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span></code></pre></div><p>This entity only needs to implement <code>IAuditLog</code>, but a default implementation of this interface <code>DefaultAuditLog</code> is provided for your convenience. <code>DefaultAuditLog</code> contains additional properties <code>ClientIp</code>, <code>Referrer</code>, and <code>Endpoint</code> for recording information about the HTTP request (if available), and also comes pre-configured for security with Create, Edit, and Delete APIs disabled.</p><p>You should further augment this type with any additional properties that you would like to track on each change record. A property to track the user who performed the change should be added, since it is not provided by the default implementation so that you can declare it yourself with the correct type for the foreign key and navigation property.</p><p>You should also apply security to restrict reading of these records to only the most privileged users with a <a href="/Coalesce/modeling/model-components/attributes/security-attribute.html#read">Read Attribute</a> (as in the example above) and/or a <a href="/Coalesce/modeling/model-components/data-sources.html#defining-data-sources">custom Default Data Source</a>.</p><h3 id="_3-configure-your-dbcontext" tabindex="-1">3. Configure your <code>DbContext</code> <a class="header-anchor" href="#_3-configure-your-dbcontext" aria-label="Permalink to &quot;3. Configure your \`DbContext\`&quot;">​</a></h3><p>On your <code>DbContext</code>, implement the <code>IAuditLogDbContext&lt;AuditLog&gt;</code> interface using the class you just created as the type parameter. Then register the Coalesce audit logging extension in your <code>DbContext</code>&#39;s <code>OnConfiguring</code> method so that saves will be intercepted and audit log entries created.</p><div class="language-c#"><button title="Copy Code" class="copy"></button><span class="lang">c#</span><pre class="shiki dark-plus vp-code"><code><span class="line"><span style="color:#D4D4D4;">[</span><span style="color:#4EC9B0;">Coalesce</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#569CD6;">public</span><span style="color:#569CD6;"> class</span><span style="color:#4EC9B0;"> AppDbContext</span><span style="color:#D4D4D4;"> : </span><span style="color:#4EC9B0;">DbContext</span><span style="color:#D4D4D4;">, </span><span style="color:#4EC9B0;">IAuditLogDbContext</span><span style="color:#D4D4D4;">&lt;</span><span style="color:#4EC9B0;">AuditLog</span><span style="color:#D4D4D4;">&gt;</span></span>
<span class="line"><span style="color:#D4D4D4;">{</span></span>
<span class="line"><span style="color:#569CD6;">    public</span><span style="color:#4EC9B0;"> DbSet</span><span style="color:#D4D4D4;">&lt;</span><span style="color:#4EC9B0;">AuditLog</span><span style="color:#D4D4D4;">&gt; </span><span style="color:#9CDCFE;">AuditLogs</span><span style="color:#D4D4D4;"> { </span><span style="color:#569CD6;">get</span><span style="color:#D4D4D4;">; </span><span style="color:#569CD6;">set</span><span style="color:#D4D4D4;">; }</span></span>
<span class="line"><span style="color:#569CD6;">    public</span><span style="color:#4EC9B0;"> DbSet</span><span style="color:#D4D4D4;">&lt;</span><span style="color:#4EC9B0;">AuditLogProperty</span><span style="color:#D4D4D4;">&gt; </span><span style="color:#9CDCFE;">AuditLogProperties</span><span style="color:#D4D4D4;"> { </span><span style="color:#569CD6;">get</span><span style="color:#D4D4D4;">; </span><span style="color:#569CD6;">set</span><span style="color:#D4D4D4;">; }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6;">    protected</span><span style="color:#569CD6;"> override</span><span style="color:#569CD6;"> void</span><span style="color:#DCDCAA;"> OnConfiguring</span><span style="color:#D4D4D4;">(</span><span style="color:#4EC9B0;">DbContextOptionsBuilder</span><span style="color:#9CDCFE;"> optionsBuilder</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">    {</span></span>
<span class="line"><span style="color:#9CDCFE;">        optionsBuilder</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">UseCoalesceAuditLogging</span><span style="color:#D4D4D4;">&lt;</span><span style="color:#4EC9B0;">AuditLog</span><span style="color:#D4D4D4;">&gt;(</span><span style="color:#9CDCFE;">x</span><span style="color:#D4D4D4;"> =&gt; </span><span style="color:#9CDCFE;">x</span></span>
<span class="line"><span style="color:#D4D4D4;">            .</span><span style="color:#DCDCAA;">WithAugmentation</span><span style="color:#D4D4D4;">&lt;</span><span style="color:#4EC9B0;">OperationContext</span><span style="color:#D4D4D4;">&gt;()</span></span>
<span class="line"><span style="color:#D4D4D4;">        );</span></span>
<span class="line"><span style="color:#D4D4D4;">    }</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span></code></pre></div><p>You could also perform this setup in your web project when calling <code>.AddDbContext()</code>.</p><p>The above code also contains a reference to a class <code>OperationContext</code>. This is the service that will allow you to populate additional custom properties on your audit entries. You&#39;ll want to define it as follows:</p><div class="language-c#"><button title="Copy Code" class="copy"></button><span class="lang">c#</span><pre class="shiki dark-plus vp-code"><code><span class="line"><span style="color:#569CD6;">public</span><span style="color:#569CD6;"> class</span><span style="color:#4EC9B0;"> OperationContext</span><span style="color:#D4D4D4;"> : </span><span style="color:#4EC9B0;">DefaultAuditOperationContext</span><span style="color:#D4D4D4;">&lt;</span><span style="color:#4EC9B0;">AuditLog</span><span style="color:#D4D4D4;">&gt;</span></span>
<span class="line"><span style="color:#D4D4D4;">{</span></span>
<span class="line"><span style="color:#6A9955;">    // Inject any additional desired services in the constructor:</span></span>
<span class="line"><span style="color:#569CD6;">    public</span><span style="color:#DCDCAA;"> OperationContext</span><span style="color:#D4D4D4;">(</span><span style="color:#4EC9B0;">IHttpContextAccessor</span><span style="color:#9CDCFE;"> accessor</span><span style="color:#D4D4D4;">) : </span><span style="color:#569CD6;">base</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">accessor</span><span style="color:#D4D4D4;">) { }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6;">    public</span><span style="color:#569CD6;"> override</span><span style="color:#569CD6;"> void</span><span style="color:#DCDCAA;"> Populate</span><span style="color:#D4D4D4;">(</span><span style="color:#4EC9B0;">AuditLog</span><span style="color:#9CDCFE;"> auditEntry</span><span style="color:#D4D4D4;">, </span><span style="color:#4EC9B0;">EntityEntry</span><span style="color:#9CDCFE;"> changedEntity</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">    {</span></span>
<span class="line"><span style="color:#569CD6;">        base</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">Populate</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">auditEntry</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">changedEntity</span><span style="color:#D4D4D4;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;">        // Adjust as needed to retrieve your UserId from the ClaimsPrincipal.</span></span>
<span class="line"><span style="color:#9CDCFE;">        auditEntry</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">UserId</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">User</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">GetUserId</span><span style="color:#D4D4D4;">();</span></span>
<span class="line"><span style="color:#D4D4D4;">    }</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span></code></pre></div><p>When you&#39;re inheriting from <code>DefaultAuditLog</code> for your <code>IAuditLog</code> implementation, you&#39;ll want to similarly inherit from <code>DefaultAuditOperationContext&lt;&gt;</code> for your operation context. It will take care of populating the HTTP request tracking fields on the <code>AuditLog</code> record. If you want a totally custom implementation, you only need to implement the <code>IAuditOperationContext&lt;TAuditLog&gt;</code> interface.</p><p>The operation context class passed to <code>WithAugmentation</code> will be injected from the application service provider if available; otherwise, a new instance will be constructed using dependencies from the application service provider. To make an injected dependency optional, make the constructor parameter nullable with a default value of <code>null</code>, or create <a href="https://learn.microsoft.com/en-us/dotnet/core/extensions/dependency-injection#multiple-constructor-discovery-rules" target="_blank" rel="noreferrer">alternate constructors</a>.</p><h3 id="_4-add-the-ui" tabindex="-1">4. Add the UI <a class="header-anchor" href="#_4-add-the-ui" aria-label="Permalink to &quot;4. Add the UI&quot;">​</a></h3><p>For Vue applications, the <a href="/Coalesce/stacks/vue/coalesce-vue-vuetify/components/c-admin-audit-log-page.html">c-admin-audit-log-page</a> component provides an out-of-the-box user interface for browsing through audit logs. Simply define the following route in your application&#39;s router:</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki dark-plus vp-code"><code><span class="line"><span style="color:#C586C0;">import</span><span style="color:#D4D4D4;"> { </span><span style="color:#9CDCFE;">CAdminAuditLogPage</span><span style="color:#D4D4D4;"> } </span><span style="color:#C586C0;">from</span><span style="color:#CE9178;"> &#39;coalesce-vue-vuetify3&#39;</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">{</span></span>
<span class="line"><span style="color:#C8C8C8;">  path</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">&#39;/admin/audit-logs&#39;</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#C8C8C8;">  component</span><span style="color:#D4D4D4;">: </span><span style="color:#9CDCFE;">CAdminAuditLogPage</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#C8C8C8;">  props</span><span style="color:#D4D4D4;">: { </span><span style="color:#C8C8C8;">type</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">&#39;AuditLog&#39;</span><span style="color:#D4D4D4;"> }</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span></code></pre></div><h2 id="configuration" tabindex="-1">Configuration <a class="header-anchor" href="#configuration" aria-label="Permalink to &quot;Configuration&quot;">​</a></h2><h3 id="suppression" tabindex="-1">Suppression <a class="header-anchor" href="#suppression" aria-label="Permalink to &quot;Suppression&quot;">​</a></h3><p>You can turn audit logging on or off for individual operations by implementing the <code>SuppressAudit</code> property on your DbContext. For example, implement it as an auto-property as follows and then set it to <code>true</code> in application code when desired:</p><div class="language-c#"><button title="Copy Code" class="copy"></button><span class="lang">c#</span><pre class="shiki dark-plus vp-code"><code><span class="line"><span style="color:#D4D4D4;">[</span><span style="color:#4EC9B0;">Coalesce</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#569CD6;">public</span><span style="color:#569CD6;"> class</span><span style="color:#4EC9B0;"> AppDbContext</span><span style="color:#D4D4D4;"> : </span><span style="color:#4EC9B0;">DbContext</span><span style="color:#D4D4D4;">, </span><span style="color:#4EC9B0;">IAuditLogDbContext</span><span style="color:#D4D4D4;">&lt;</span><span style="color:#4EC9B0;">AuditLog</span><span style="color:#D4D4D4;">&gt;</span></span>
<span class="line"><span style="color:#D4D4D4;">{</span></span>
<span class="line"><span style="color:#D4D4D4;">    ...</span></span>
<span class="line"><span style="color:#569CD6;">    public</span><span style="color:#569CD6;"> bool</span><span style="color:#9CDCFE;"> SuppressAudit</span><span style="color:#D4D4D4;"> { </span><span style="color:#569CD6;">get</span><span style="color:#D4D4D4;">; </span><span style="color:#569CD6;">set</span><span style="color:#D4D4D4;">; }</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span></code></pre></div><h3 id="exclusions-formatting" tabindex="-1">Exclusions &amp; Formatting <a class="header-anchor" href="#exclusions-formatting" aria-label="Permalink to &quot;Exclusions &amp; Formatting&quot;">​</a></h3><p>Coalesce&#39;s audit logging is built on top of <a href="https://entityframework-plus.net/ef-core-audit" target="_blank" rel="noreferrer">Entity Framework Plus</a> and can be configured using all of its <a href="https://entityframework-plus.net/ef-core-audit#scenarios" target="_blank" rel="noreferrer">configuration</a>, including <a href="https://entityframework-plus.net/ef-core-audit-exclude-include-entity" target="_blank" rel="noreferrer">includes/excludes</a> and <a href="https://entityframework-plus.net/ef-core-audit-format-value" target="_blank" rel="noreferrer">custom property formatting</a>.</p><p>Coalesce will not use EF Plus&#39;s <code>AuditManager.DefaultConfiguration</code> global singleton instance. You must use Coalesce&#39;s configuration extensions which allow for more targeted configuration per context that does not rely on a global static singleton. For example:</p><div class="language-c#"><button title="Copy Code" class="copy"></button><span class="lang">c#</span><pre class="shiki dark-plus vp-code"><code><span class="line"><span style="color:#569CD6;">public</span><span style="color:#569CD6;"> class</span><span style="color:#4EC9B0;"> AppDbContext</span><span style="color:#D4D4D4;"> : </span><span style="color:#4EC9B0;">DbContext</span><span style="color:#D4D4D4;">, </span><span style="color:#4EC9B0;">IAuditLogDbContext</span><span style="color:#D4D4D4;">&lt;</span><span style="color:#4EC9B0;">AuditLog</span><span style="color:#D4D4D4;">&gt;</span></span>
<span class="line"><span style="color:#D4D4D4;">{</span></span>
<span class="line"><span style="color:#569CD6;">    protected</span><span style="color:#569CD6;"> override</span><span style="color:#569CD6;"> void</span><span style="color:#DCDCAA;"> OnConfiguring</span><span style="color:#D4D4D4;">(</span><span style="color:#4EC9B0;">DbContextOptionsBuilder</span><span style="color:#9CDCFE;"> optionsBuilder</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">    {</span></span>
<span class="line"><span style="color:#9CDCFE;">        optionsBuilder</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">UseCoalesceAuditLogging</span><span style="color:#D4D4D4;">&lt;</span><span style="color:#4EC9B0;">AuditLog</span><span style="color:#D4D4D4;">&gt;(</span><span style="color:#9CDCFE;">x</span><span style="color:#D4D4D4;"> =&gt; </span><span style="color:#9CDCFE;">x</span></span>
<span class="line"><span style="color:#D4D4D4;">            .</span><span style="color:#DCDCAA;">WithAugmentation</span><span style="color:#D4D4D4;">&lt;</span><span style="color:#4EC9B0;">OperationContext</span><span style="color:#D4D4D4;">&gt;()</span></span>
<span class="line"><span style="color:#D4D4D4;">            .</span><span style="color:#DCDCAA;">ConfigureAudit</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">c</span><span style="color:#D4D4D4;"> =&gt; </span><span style="color:#9CDCFE;">c</span></span>
<span class="line"><span style="color:#D4D4D4;">                .</span><span style="color:#DCDCAA;">Exclude</span><span style="color:#D4D4D4;">&lt;</span><span style="color:#4EC9B0;">DataProtectionKey</span><span style="color:#D4D4D4;">&gt;()</span></span>
<span class="line"><span style="color:#D4D4D4;">                .</span><span style="color:#DCDCAA;">ExcludeProperty</span><span style="color:#D4D4D4;">&lt;</span><span style="color:#4EC9B0;">TrackingBase</span><span style="color:#D4D4D4;">&gt;(</span><span style="color:#9CDCFE;">x</span><span style="color:#D4D4D4;"> =&gt; </span><span style="color:#569CD6;">new</span><span style="color:#D4D4D4;"> { </span><span style="color:#9CDCFE;">x</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">CreatedById</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">x</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">CreatedOn</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">x</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">ModifiedById</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">x</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">ModifiedOn</span><span style="color:#D4D4D4;"> })</span></span>
<span class="line"><span style="color:#D4D4D4;">                .</span><span style="color:#DCDCAA;">FormatType</span><span style="color:#D4D4D4;">&lt;</span><span style="color:#4EC9B0;">DateTimeOffset</span><span style="color:#D4D4D4;">&gt;(</span><span style="color:#9CDCFE;">d</span><span style="color:#D4D4D4;"> =&gt; </span><span style="color:#9CDCFE;">d</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">ToTimeZone</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;America/Los_Angeles&quot;</span><span style="color:#D4D4D4;">).</span><span style="color:#DCDCAA;">ToString</span><span style="color:#D4D4D4;">())</span></span>
<span class="line"><span style="color:#D4D4D4;">                .</span><span style="color:#DCDCAA;">Format</span><span style="color:#D4D4D4;">&lt;</span><span style="color:#4EC9B0;">Image</span><span style="color:#D4D4D4;">&gt;(</span><span style="color:#9CDCFE;">x</span><span style="color:#D4D4D4;"> =&gt; </span><span style="color:#9CDCFE;">x</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">Content</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">x</span><span style="color:#D4D4D4;"> =&gt; </span><span style="color:#CE9178;">$&quot;{</span><span style="color:#9CDCFE;">Convert</span><span style="color:#CE9178;">.</span><span style="color:#DCDCAA;">ToHexString</span><span style="color:#CE9178;">(</span><span style="color:#9CDCFE;">SHA1</span><span style="color:#CE9178;">.</span><span style="color:#DCDCAA;">HashData</span><span style="color:#CE9178;">(</span><span style="color:#9CDCFE;">x</span><span style="color:#CE9178;">))}, {</span><span style="color:#9CDCFE;">x</span><span style="color:#CE9178;">.</span><span style="color:#9CDCFE;">Length</span><span style="color:#CE9178;">} bytes&quot;</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">            )</span></span>
<span class="line"><span style="color:#D4D4D4;">        );</span></span>
<span class="line"><span style="color:#D4D4D4;">    }</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span></code></pre></div><h3 id="property-descriptions" tabindex="-1">Property Descriptions <a class="header-anchor" href="#property-descriptions" aria-label="Permalink to &quot;Property Descriptions&quot;">​</a></h3><p>The <code>AuditLogProperty</code> children of your <code>IAuditLog</code> implementation have two properties <code>OldValueDescription</code> and <code>NewValueDescription</code> that can be used to hold a description of the old and new values. By default, Coalesce will populate the descriptions of foreign key properties with the <a href="/Coalesce/modeling/model-components/attributes/list-text.html">List Text</a> of the referenced principal entity. This greatly improves the usability of the audit logs, which would otherwise only show meaningless numbers or GUIDs for foreign keys that changed.</p><p>This feature will load principal entities into the <code>DbContext</code> if they are not already loaded, which could inflict subtle differences in application functionality in rare edge cases if your application is making assumptions about navigation properties not being loaded. Typically though, this will not be an issue and will not lead unintentional information disclosure to clients as long as <a href="/Coalesce/concepts/include-tree.html">IncludeTree</a>s are used correctly.</p><p>This feature may be disabled by calling <code>.WithPropertyDescriptions(PropertyDescriptionMode.None)</code> inside your call to <code>.UseCoalesceAuditLogging(...)</code> in your DbContext configuration. You may also populate these descriptions in your <code>IAuditOperationContext</code> implementation that was provided to <code>.WithAugmentation&lt;T&gt;()</code>.</p><h2 id="merging" tabindex="-1">Merging <a class="header-anchor" href="#merging" aria-label="Permalink to &quot;Merging&quot;">​</a></h2><p>When using a supported database provider (currently only SQL Server), audit records for changes to the same entity can be merged together when the change is identical in all aspects to the previous audit record for that entity, with the only allowed difference being the old/new property values.</p><p>In other words, if the same user is making repeated changes to the same property on the same entity from the same page, then those changes will merge together into one audit record.</p><p>This merging only happens together if the existing audit record is recent; the default cutoff for this is 30 seconds, but can be configured with <code>.WithMergeWindow(TimeSpan.FromSeconds(15))</code> when calling <code>UseCoalesceAuditLogging</code>. It can also be turned off by setting this value to <code>TimeSpan.Zero</code>. The merging logic respects all custom properties you add to your <code>IAuditLog</code> implementation, requiring their values to match between the existing and new audit records for a merge to occur.</p><p>By default, only non-discrete properties (those that are not foreign keys, booleans, or enums) are candidates for merging, since it is usually only such fields that will have repeated changes while a user is typing in an auto-save user interface. For other types of properties, it is usually better to capture each discrete change. This can be configured with <code>.WithMergeBehavior()</code> when calling <code>UseCoalesceAuditLogging</code>, and can be overridden on a case-by-case basis by setting <code>AuditLogProperty.CanMerge</code> in your <code>IAuditOperationContext.Populate</code> implementation.</p><h2 id="caveats" tabindex="-1">Caveats <a class="header-anchor" href="#caveats" aria-label="Permalink to &quot;Caveats&quot;">​</a></h2><p>Only changes that are tracked by the <code>DbContext</code>&#39;s <code>ChangeTracker</code> can be audited. Changes that are made with raw SQL, or changes that are made with bulk update functions like <a href="https://learn.microsoft.com/en-us/ef/core/performance/efficient-updating?tabs=ef7" target="_blank" rel="noreferrer"><code>ExecuteUpdate</code> or <code>ExecuteDelete</code></a> will not be audited using this package.</p><h2 id="audit-stamping" tabindex="-1">Audit Stamping <a class="header-anchor" href="#audit-stamping" aria-label="Permalink to &quot;Audit Stamping&quot;">​</a></h2><p>A lightweight alternative or addition to full audit logging is audit stamping - the process of setting fields like <code>CreatedBy</code> or <code>ModifiedOn</code> on each changed entity. This cannot record a history of exact changes, but can at least record the age of an entity and how recently it changed.</p><p>Coalesce offers a simple mechanism to register an Entity Framework save interceptor to perform this kind of action (this <strong>does NOT</strong> require the <code>IntelliTect.Coalesce.AuditLogging</code> package). This mechanism operations on all saves that go through Entity Framework, eliminating the need to perform this manually in individual Behaviors, Services, and Custom Methods:</p><div class="language-c#"><button title="Copy Code" class="copy"></button><span class="lang">c#</span><pre class="shiki dark-plus vp-code"><code><span class="line"><span style="color:#9CDCFE;">services</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">AddDbContext</span><span style="color:#D4D4D4;">&lt;</span><span style="color:#4EC9B0;">AppDbContext</span><span style="color:#D4D4D4;">&gt;(</span><span style="color:#9CDCFE;">options</span><span style="color:#D4D4D4;"> =&gt; </span><span style="color:#9CDCFE;">options</span></span>
<span class="line"><span style="color:#D4D4D4;">    .</span><span style="color:#DCDCAA;">UseSqlServer</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">connectionString</span><span style="color:#D4D4D4;">) </span><span style="color:#6A9955;">// (or other provider)</span></span>
<span class="line"><span style="color:#D4D4D4;">    .</span><span style="color:#DCDCAA;">UseStamping</span><span style="color:#D4D4D4;">&lt;</span><span style="color:#4EC9B0;">TrackingBase</span><span style="color:#D4D4D4;">&gt;((</span><span style="color:#9CDCFE;">entity</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">user</span><span style="color:#D4D4D4;">) =&gt; </span><span style="color:#9CDCFE;">entity</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">SetTracking</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">user</span><span style="color:#D4D4D4;">))</span></span>
<span class="line"><span style="color:#D4D4D4;">);</span></span></code></pre></div><p>In the above example, <code>TrackingBase</code> is an interface or class that you would write as part of your application that defines the properties and mechanisms for performing the tracking operation. For example:</p><div class="language-c#"><button title="Copy Code" class="copy"></button><span class="lang">c#</span><pre class="shiki dark-plus vp-code"><code><span class="line"><span style="color:#569CD6;">public</span><span style="color:#569CD6;"> abstract</span><span style="color:#569CD6;"> class</span><span style="color:#4EC9B0;"> TrackingBase</span></span>
<span class="line"><span style="color:#D4D4D4;">{</span></span>
<span class="line"><span style="color:#D4D4D4;">    [</span><span style="color:#4EC9B0;">Read</span><span style="color:#D4D4D4;">, </span><span style="color:#4EC9B0;">Display</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">Order</span><span style="color:#D4D4D4;"> = </span><span style="color:#B5CEA8;">1000</span><span style="color:#D4D4D4;">)]</span></span>
<span class="line"><span style="color:#569CD6;">    public</span><span style="color:#4EC9B0;"> ApplicationUser</span><span style="color:#9CDCFE;"> CreatedBy</span><span style="color:#D4D4D4;"> { </span><span style="color:#569CD6;">get</span><span style="color:#D4D4D4;">; </span><span style="color:#569CD6;">set</span><span style="color:#D4D4D4;">; }</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span></span>
<span class="line"><span style="color:#D4D4D4;">    [</span><span style="color:#4EC9B0;">Read</span><span style="color:#D4D4D4;">, </span><span style="color:#4EC9B0;">Display</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">Order</span><span style="color:#D4D4D4;"> = </span><span style="color:#B5CEA8;">1001</span><span style="color:#D4D4D4;">)]</span></span>
<span class="line"><span style="color:#569CD6;">    public</span><span style="color:#569CD6;"> string</span><span style="color:#D4D4D4;">? </span><span style="color:#9CDCFE;">CreatedById</span><span style="color:#D4D4D4;"> { </span><span style="color:#569CD6;">get</span><span style="color:#D4D4D4;">; </span><span style="color:#569CD6;">set</span><span style="color:#D4D4D4;">; }</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span></span>
<span class="line"><span style="color:#D4D4D4;">    [</span><span style="color:#4EC9B0;">Read</span><span style="color:#D4D4D4;">, </span><span style="color:#4EC9B0;">Display</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">Order</span><span style="color:#D4D4D4;"> = </span><span style="color:#B5CEA8;">1002</span><span style="color:#D4D4D4;">)]</span></span>
<span class="line"><span style="color:#569CD6;">    public</span><span style="color:#4EC9B0;"> DateTimeOffset</span><span style="color:#9CDCFE;"> CreatedOn</span><span style="color:#D4D4D4;"> { </span><span style="color:#569CD6;">get</span><span style="color:#D4D4D4;">; </span><span style="color:#569CD6;">set</span><span style="color:#D4D4D4;">; }</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">    [</span><span style="color:#4EC9B0;">Read</span><span style="color:#D4D4D4;">, </span><span style="color:#4EC9B0;">Display</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">Order</span><span style="color:#D4D4D4;"> = </span><span style="color:#B5CEA8;">1003</span><span style="color:#D4D4D4;">)]</span></span>
<span class="line"><span style="color:#569CD6;">    public</span><span style="color:#4EC9B0;"> ApplicationUser</span><span style="color:#9CDCFE;"> ModifiedBy</span><span style="color:#D4D4D4;"> { </span><span style="color:#569CD6;">get</span><span style="color:#D4D4D4;">; </span><span style="color:#569CD6;">set</span><span style="color:#D4D4D4;">; }</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span></span>
<span class="line"><span style="color:#D4D4D4;">    [</span><span style="color:#4EC9B0;">Read</span><span style="color:#D4D4D4;">, </span><span style="color:#4EC9B0;">Display</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">Order</span><span style="color:#D4D4D4;"> = </span><span style="color:#B5CEA8;">1004</span><span style="color:#D4D4D4;">)]</span></span>
<span class="line"><span style="color:#569CD6;">    public</span><span style="color:#569CD6;"> string</span><span style="color:#D4D4D4;">? </span><span style="color:#9CDCFE;">ModifiedById</span><span style="color:#D4D4D4;"> { </span><span style="color:#569CD6;">get</span><span style="color:#D4D4D4;">; </span><span style="color:#569CD6;">set</span><span style="color:#D4D4D4;">; }</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span></span>
<span class="line"><span style="color:#D4D4D4;">    [</span><span style="color:#4EC9B0;">Read</span><span style="color:#D4D4D4;">, </span><span style="color:#4EC9B0;">Display</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">Order</span><span style="color:#D4D4D4;"> = </span><span style="color:#B5CEA8;">1005</span><span style="color:#D4D4D4;">)]</span></span>
<span class="line"><span style="color:#569CD6;">    public</span><span style="color:#4EC9B0;"> DateTimeOffset</span><span style="color:#9CDCFE;"> ModifiedOn</span><span style="color:#D4D4D4;"> { </span><span style="color:#569CD6;">get</span><span style="color:#D4D4D4;">; </span><span style="color:#569CD6;">set</span><span style="color:#D4D4D4;">; }</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6;">    public</span><span style="color:#569CD6;"> void</span><span style="color:#DCDCAA;"> SetTracking</span><span style="color:#D4D4D4;">(</span><span style="color:#4EC9B0;">ClaimsPrincipal</span><span style="color:#D4D4D4;">? </span><span style="color:#9CDCFE;">user</span><span style="color:#D4D4D4;">) </span></span>
<span class="line"><span style="color:#D4D4D4;">        =&gt; </span><span style="color:#DCDCAA;">SetTracking</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">user</span><span style="color:#D4D4D4;">?.</span><span style="color:#DCDCAA;">GetApplicationUserId</span><span style="color:#D4D4D4;">());</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span></span>
<span class="line"><span style="color:#569CD6;">    public</span><span style="color:#569CD6;"> void</span><span style="color:#DCDCAA;"> SetTracking</span><span style="color:#D4D4D4;">(</span><span style="color:#569CD6;">int</span><span style="color:#D4D4D4;">? </span><span style="color:#9CDCFE;">userId</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">    {</span></span>
<span class="line"><span style="color:#C586C0;">        if</span><span style="color:#D4D4D4;"> (</span><span style="color:#569CD6;">this</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">CreatedById</span><span style="color:#D4D4D4;"> == </span><span style="color:#569CD6;">null</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">        {</span></span>
<span class="line"><span style="color:#569CD6;">            this</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">CreatedById</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">userId</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"><span style="color:#569CD6;">            this</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">CreatedOn</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">DateTimeOffset</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">Now</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"><span style="color:#D4D4D4;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6;">        this</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">ModifiedById</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">userId</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"><span style="color:#569CD6;">        this</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">ModifiedOn</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">DateTimeOffset</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">Now</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"><span style="color:#D4D4D4;">    }</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span></code></pre></div><p>The overload <code>UseStamping&lt;TStampable&gt;</code> will provide the <code>ClaimsPrincipal</code> from the current HTTP request if present, defaulting to <code>null</code> if an operation occurs outside an HTTP request (e.g. a background job). The overloads <code>UseStamping&lt;TStampable, TService&gt;</code> and <code>UseStamping&lt;TStampable, TService1, TService2&gt;</code> can be used to inject services into the operation. If more than two services are needed, you should wrap those dependencies up into an additional service that takes them as dependencies.</p>`,51),t=[l];function p(r,c,D,i,y,d){return n(),a("div",null,t)}const g=s(o,[["render",p]]);export{u as __pageData,g as default};
