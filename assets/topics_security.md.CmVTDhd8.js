import{_ as s,c as a,o as e,a7 as n}from"./chunks/framework.BkavzUpE.js";const o="/Coalesce/assets/security-overview.DKJVSAfO.jpg",h=JSON.parse('{"title":"Security","description":"","frontmatter":{},"headers":[],"relativePath":"topics/security.md","filePath":"topics/security.md"}'),l={name:"topics/security.md"},t=n(`<h1 id="security" tabindex="-1">Security <a class="header-anchor" href="#security" aria-label="Permalink to &quot;Security&quot;">​</a></h1><p>This page is a comprehensive overview of all the techniques that can be used in a Coalesce application to restrict the capabilities of API endpoints that Coalesce generates.</p><p>The following table is a quick reference of scenarios you might encounter and how you might handle them. If you&#39;re unfamiliar with these techniques, though, then you are encouraged to read through this page to get a deeper understanding of what&#39;s available before selecting a solution.</p><table><thead><tr><th width="150px">Feature</th><th width="190px">Restriction</th><th>Technique</th></tr></thead><tr><td rowspan="4"><p><a href="/Coalesce/modeling/model-types/crud.html">CRUD</a> Reads: <code>/get</code>, <br> <code>/list</code>, <br> <code>/count</code></p></td><td>Disable</td><td><p><a href="#class-security-attributes">[Read(DenyAll)]</a></p></td></tr><tr><td>Roles</td><td><p><a href="#class-security-attributes">[Read(&quot;RoleName&quot;)]</a></p></td></tr><tr><td><p>Prevent <a href="/Coalesce/modeling/model-components/data-sources.html#default-loading-behavior">auto-include</a></p></td><td><ul><li>Omit <code>base</code> call in Data Source <code>GetQuery</code> override.</li><li><code>[Read(NoAutoInclude = true)]</code> on properties or types.</li><li><code>[assembly: CoalesceConfiguration(NoAutoInclude = true)]</code></li></ul></td></tr><tr><td><p>Any custom code:</p><ul><li>Query Predicates</li><li>Filtered Includes</li><li>Conditional Includes</li><li>Sort/search/filter overrides</li></ul></td><td><p><a href="#data-sources">Custom Default Data Source</a></p></td></tr><tr></tr><tr><td rowspan="5"><p><a href="/Coalesce/modeling/model-types/crud.html">CRUD</a> Mutations: <code>/save</code>, <br> <code>/bulkSave</code>, <br> <code>/delete</code></p></td><td>Disable</td><td><p><a href="#class-security-attributes">[Create(DenyAll)] [Edit(DenyAll)] [Delete(DenyAll)]</a></p></td></tr><tr><td>Roles</td><td><p><a href="#class-security-attributes">[Create(&quot;Role&quot;)] [Edit(&quot;Role&quot;)] [Delete(&quot;Role&quot;)]</a></p></td></tr><tr><td>Restrict target records (edit/delete)</td><td><p><a href="#data-sources">Custom Default Data Source</a></p></td></tr><tr><td>Static Validation</td><td><p><a href="#attribute-validation">Validation attributes</a></p></td></tr><tr><td><p>Any custom code:</p><ul><li>Security</li><li>Validation</li></ul></td><td><p><a href="#behaviors">Custom Behaviors</a><br></p></td></tr><tr><td rowspan="5"><p><a href="/Coalesce/modeling/model-components/methods.html">Methods</a> and <a href="/Coalesce/modeling/model-types/services.html">Services</a></p></td><td>Disable</td><td><p>N/A - explicit opt-in required via <code>[Coalesce]</code></p></td></tr><tr><td>Roles</td><td><p><a href="#method-security-attributes">[Execute(&quot;RoleName&quot;)]</a></p></td></tr><tr><td>Static Validation</td><td><p><a href="#attribute-validation">Validation attributes</a></p></td></tr><tr><td><p>Restrict <a href="/Coalesce/modeling/model-components/methods.html#instance-methods">instance methods</a> Targets</p></td><td><ul><li><a href="#data-sources">custom Default Data Source</a></li><li>specify data source: <a href="/Coalesce/modeling/model-components/attributes/execute.html#member-datasource">[Execute(DataSource = typeof(...))]</a></li></ul></td></tr><tr><td>Other</td><td><p>Write custom logic in the method.</p></td></tr><tr><td rowspan="8"><p><a href="/Coalesce/modeling/model-components/properties.html">Properties</a><br><small style="display:block;line-height:1.3;"> (All input and output for Entity CRUD, Methods, and Services) </small></p></td><td>Globally Exclude</td><td><ul><li><a href="#internal-properties">[InternalUse]</a></li><li><code>internal</code> access modifier</li></ul></td></tr><tr><td> Roles </td><td><p><a href="#role-restrictions">Property Security Attributes</a></p></td></tr><tr><td><p>Read-only</p></td><td><ul><li><code>internal</code> setter or no setter</li><li><code>[Read]</code> attribute without <code>[Edit]</code></li><li><a href="#read-only-properties">other techniques</a></li></ul></td></tr><tr><td><p>Init-only (write-once)</p></td><td><p><a href="https://learn.microsoft.com/en-us/dotnet/csharp/language-reference/keywords/init" target="_blank" rel="noreferrer"><code>init</code> setter</a></p></td></tr><tr><td><p>Custom security</p></td><td><ul><li>Navigation Properties: <a href="#data-sources">Data Sources</a></li><li>Scalar/Other Properties: <a href="#custom-restrictions">Property Restrictions</a></li></ul></td></tr></table><h2 id="endpoint-security" tabindex="-1">Endpoint Security <a class="header-anchor" href="#endpoint-security" aria-label="Permalink to &quot;Endpoint Security&quot;">​</a></h2><p>Coalesce generates API endpoints by traversing your data model&#39;s classes, starting from types annotated with <code>[Coalesce]</code>. This usually includes your <code>DbContext</code> class, as well as any <a href="/Coalesce/modeling/model-types/services.html">Service</a> classes or interfaces.</p><p>Classes can be hidden from Coalesce entirely by annotating them with <code>[InternalUse]</code>, preventing generation of API endpoints for that class, as well as preventing properties of that type from being exposed.</p><p><code>DbSet&lt;&gt;</code> properties on your <code>DbContext</code> class can also be annotated with <code>[InternalUse]</code>, causing that type to be treated by Coalesce like an <a href="/Coalesce/modeling/model-types/external-types.html">External Type</a> rather than an <a href="/Coalesce/modeling/model-types/entities.html">Entity</a>, once again preventing generation of API endpoints but <em>without</em> preventing properties of that type from being exposed.</p><h3 id="class-security-attributes" tabindex="-1">Class Security Attributes <a class="header-anchor" href="#class-security-attributes" aria-label="Permalink to &quot;Class Security Attributes&quot;">​</a></h3><p>For each of your <a href="/Coalesce/modeling/model-types/crud.html">CRUD Models</a>, Coalesce generates a set of API endpoints (<code>/get</code>, <code>/list</code>, <code>/count</code>, <code>/save</code>, <code>/bulkSave</code>, and <code>/delete</code>).</p><p>The default behavior is that all endpoints require an authenticated user (anonymous users are rejected).</p><p>These endpoints can be secured by placing any or all of the <a href="/Coalesce/modeling/model-components/attributes/security-attribute.html">[Read], [Create], [Edit], and [Delete] attributes</a> on the the class. Each attribute can specify required roles for that action, or open that action to anonymous, unauthenticated users, or disable the endpoint entirely.</p><p>This security is applied to the generated <a href="https://learn.microsoft.com/en-us/aspnet/core/mvc/controllers/actions" target="_blank" rel="noreferrer">controllers</a>. The <code>[Read]</code> attribute on a class <strong><em>does not</em></strong> affect instances of that class when those instances are present as child properties of other types, since in those scenarios the data will be coming from a different endpoint on a different controller.</p><table><thead><tr><th>Endpoints</th><th>Governing Attributes</th></tr></thead><tr><td><p><code>/get</code>, <code>/list</code>, <code>/count</code></p></td><td><div class="language-c#"><button title="Copy Code" class="copy"></button><span class="lang">c#</span><pre class="shiki dark-plus vp-code"><code><span class="line"><span style="color:#D4D4D4;">[</span><span style="color:#4EC9B0;">ReadAttribute</span><span style="color:#D4D4D4;">]</span></span></code></pre></div></td></tr><tr><td><p><code>/save</code></p></td><td><div class="language-c#"><button title="Copy Code" class="copy"></button><span class="lang">c#</span><pre class="shiki dark-plus vp-code"><code><span class="line"><span style="color:#D4D4D4;">[</span><span style="color:#4EC9B0;">CreateAttribute</span><span style="color:#D4D4D4;">] </span><span style="color:#6A9955;">// Affects saves of new entities</span></span>
<span class="line"><span style="color:#D4D4D4;">[</span><span style="color:#4EC9B0;">EditAttribute</span><span style="color:#D4D4D4;">]   </span><span style="color:#6A9955;">// Affects saves of existing entities</span></span></code></pre></div></td></tr><tr><td><p><code>/delete</code></p></td><td><div class="language-c#"><button title="Copy Code" class="copy"></button><span class="lang">c#</span><pre class="shiki dark-plus vp-code"><code><span class="line"><span style="color:#D4D4D4;">[</span><span style="color:#4EC9B0;">DeleteAttribute</span><span style="color:#D4D4D4;">]</span></span></code></pre></div></td></tr><tr><td><p><code>/bulkSave</code></p></td><td><div class="language-c#"><button title="Copy Code" class="copy"></button><span class="lang">c#</span><pre class="shiki dark-plus vp-code"><code><span class="line"><span style="color:#6A9955;">// Read permission required for the root entity:</span></span>
<span class="line"><span style="color:#D4D4D4;">[</span><span style="color:#4EC9B0;">ReadAttribute</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;">// Control of each entity affected by the bulk save:</span></span>
<span class="line"><span style="color:#D4D4D4;">[</span><span style="color:#4EC9B0;">CreateAttribute</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">[</span><span style="color:#4EC9B0;">EditAttribute</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">[</span><span style="color:#4EC9B0;">DeleteAttribute</span><span style="color:#D4D4D4;">]</span></span></code></pre></div></td></tr></table><p>Here are some examples of applying security attributes to an entity class. If a particular action doesn&#39;t need to be restricted, you can omit that attribute, but this example shows usages of all four:</p><div class="language-c#"><button title="Copy Code" class="copy"></button><span class="lang">c#</span><pre class="shiki dark-plus vp-code"><code><span class="line"><span style="color:#6A9955;">// Allow read access by unauthenticated, anonymous users:</span></span>
<span class="line"><span style="color:#D4D4D4;">[</span><span style="color:#4EC9B0;">Read</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">SecurityPermissionLevels</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">AllowAll</span><span style="color:#D4D4D4;">)]</span></span>
<span class="line"><span style="color:#6A9955;">// Allow creation of new entities by the Admin and HR roles (params string[] style):</span></span>
<span class="line"><span style="color:#D4D4D4;">[</span><span style="color:#4EC9B0;">Create</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;Admin&quot;</span><span style="color:#D4D4D4;">, </span><span style="color:#CE9178;">&quot;HR&quot;</span><span style="color:#D4D4D4;">)]</span></span>
<span class="line"><span style="color:#6A9955;">// Allow editing of existing Employee entities by users with the Admin or HR roles (CSV style):</span></span>
<span class="line"><span style="color:#D4D4D4;">[</span><span style="color:#4EC9B0;">Edit</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;Admin,HR&quot;</span><span style="color:#D4D4D4;">)]</span></span>
<span class="line"><span style="color:#6A9955;">// Prohibit deletion of Employee entities</span></span>
<span class="line"><span style="color:#D4D4D4;">[</span><span style="color:#4EC9B0;">Delete</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">SecurityPermissionLevels</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">DenyAll</span><span style="color:#D4D4D4;">)]</span></span>
<span class="line"><span style="color:#569CD6;">public</span><span style="color:#569CD6;"> class</span><span style="color:#4EC9B0;"> Employee</span></span>
<span class="line"><span style="color:#D4D4D4;">{</span></span>
<span class="line"><span style="color:#569CD6;">    public</span><span style="color:#569CD6;"> int</span><span style="color:#9CDCFE;"> EmployeeId</span><span style="color:#D4D4D4;"> { </span><span style="color:#569CD6;">get</span><span style="color:#D4D4D4;">; </span><span style="color:#569CD6;">set</span><span style="color:#D4D4D4;">; }</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span></code></pre></div><h3 id="method-security-attributes" tabindex="-1">Method Security Attributes <a class="header-anchor" href="#method-security-attributes" aria-label="Permalink to &quot;Method Security Attributes&quot;">​</a></h3><p>To secure the endpoints generated for your <a href="/Coalesce/modeling/model-components/methods.html">Custom Methods</a> and <a href="/Coalesce/modeling/model-types/services.html">Services</a>, the <a href="/Coalesce/modeling/model-components/attributes/execute.html">[Execute] attribute</a> can be used to specify a set of required roles for that endpoint, or to open that endpoint to anonymous users.</p><p>The default behavior is that all endpoints require an authenticated user (anonymous users are rejected).</p><p>For example:</p><div class="language-c#"><button title="Copy Code" class="copy"></button><span class="lang">c#</span><pre class="shiki dark-plus vp-code"><code><span class="line"><span style="color:#569CD6;">public</span><span style="color:#569CD6;"> class</span><span style="color:#4EC9B0;"> Employee</span></span>
<span class="line"><span style="color:#D4D4D4;">{</span></span>
<span class="line"><span style="color:#569CD6;">    public</span><span style="color:#569CD6;"> int</span><span style="color:#9CDCFE;"> EmployeeId</span><span style="color:#D4D4D4;"> { </span><span style="color:#569CD6;">get</span><span style="color:#D4D4D4;">; </span><span style="color:#569CD6;">set</span><span style="color:#D4D4D4;">; }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">    [</span><span style="color:#4EC9B0;">Coalesce</span><span style="color:#D4D4D4;">, </span><span style="color:#4EC9B0;">Execute</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;Payroll,HR&quot;</span><span style="color:#D4D4D4;">)]</span></span>
<span class="line"><span style="color:#569CD6;">    public</span><span style="color:#569CD6;"> void</span><span style="color:#DCDCAA;"> GiveRaise</span><span style="color:#D4D4D4;">(</span><span style="color:#569CD6;">int</span><span style="color:#9CDCFE;"> centsPerHour</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#6A9955;">        // Only Payroll and HR users can call this method</span></span>
<span class="line"><span style="color:#D4D4D4;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">    [</span><span style="color:#4EC9B0;">Coalesce</span><span style="color:#D4D4D4;">, </span><span style="color:#4EC9B0;">Execute</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">SecurityPermissionLevels</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">AllowAll</span><span style="color:#D4D4D4;">)]</span></span>
<span class="line"><span style="color:#569CD6;">    public</span><span style="color:#569CD6;"> void</span><span style="color:#DCDCAA;"> SendMessage</span><span style="color:#D4D4D4;">(</span><span style="color:#569CD6;">string</span><span style="color:#9CDCFE;"> message</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#6A9955;">        // Anyone (even anonymous, unauthenticated users) can call this method.</span></span>
<span class="line"><span style="color:#D4D4D4;">    }</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span></code></pre></div><h2 id="property-column-security" tabindex="-1">Property/Column Security <a class="header-anchor" href="#property-column-security" aria-label="Permalink to &quot;Property/Column Security&quot;">​</a></h2><p>Security applied to properties with attributes in Coalesce affects all usages of that property across all Coalesce-generated APIs. This includes usages of that property on types that occur as children of other types, which is a spot where class-level or endpoint-level security generally does not apply. <a href="/Coalesce/modeling/model-components/attributes/security-attribute.html">These attributes</a> can be placed on the properties on your <a href="/Coalesce/modeling/model-types/entities.html">Entities</a> and <a href="/Coalesce/modeling/model-types/external-types.html">External Types</a> to apply role-based restrictions to that property.</p><ul><li><code>ReadAttribute</code> limits the roles that can read values from that property in responses from the server.</li><li><code>EditAttribute</code> limits the roles that can write values to that property in requests made to the server.</li><li><code>RestrictAttribute</code> registers an implementation of <a href="#custom-restrictions">IPropertyRestriction</a> that allows for writing custom code to implement these restrictions.</li></ul><p>This security is executed and enforced by the mapping that occurs in the <a href="/Coalesce/stacks/agnostic/dtos.html">generated DTOs</a>, meaning it affects both entity CRUD APIs as well as <a href="/Coalesce/modeling/model-components/methods.html">Custom Methods</a>. It is also checked by the <a href="/Coalesce/modeling/model-components/data-sources.html#standard-data-source">Standard Data Source</a> to prevent sorting, searching, and filtering by properties that a user is not permitted to read.</p><h3 id="internal-properties" tabindex="-1">Internal Properties <a class="header-anchor" href="#internal-properties" aria-label="Permalink to &quot;Internal Properties&quot;">​</a></h3><p>Properties can be hidden from Coalesce entirely, either with the <a href="/Coalesce/modeling/model-components/attributes/internal-use.html">[InternalUse]</a> attribute or non-public C# access modifiers.</p><p>The properties in the following example are hidden entirely from all Coalesce functionality and generated APIs:</p><div class="language-c#"><button title="Copy Code" class="copy"></button><span class="lang">c#</span><pre class="shiki dark-plus vp-code"><code><span class="line"><span style="color:#C586C0;">using</span><span style="color:#4EC9B0;"> IntelliTect</span><span style="color:#D4D4D4;">.</span><span style="color:#4EC9B0;">Coalesce</span><span style="color:#D4D4D4;">.</span><span style="color:#4EC9B0;">DataAnnotations</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"><span style="color:#569CD6;">public</span><span style="color:#569CD6;"> class</span><span style="color:#4EC9B0;"> Employee</span></span>
<span class="line"><span style="color:#D4D4D4;">{</span></span>
<span class="line"><span style="color:#6A9955;">  // InternalUseAttribute hides anything from Coalesce.</span></span>
<span class="line"><span style="color:#D4D4D4;">  [</span><span style="color:#4EC9B0;">InternalUse</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#569CD6;">  public</span><span style="color:#569CD6;"> string</span><span style="color:#9CDCFE;"> Name</span><span style="color:#D4D4D4;"> { </span><span style="color:#569CD6;">get</span><span style="color:#D4D4D4;">; </span><span style="color:#569CD6;">set</span><span style="color:#D4D4D4;">; }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;">  // Non-public C# access modifiers will hide properties from Coalesce:</span></span>
<span class="line"><span style="color:#569CD6;">  internal</span><span style="color:#569CD6;"> decimal</span><span style="color:#9CDCFE;"> Salary</span><span style="color:#D4D4D4;"> { </span><span style="color:#569CD6;">get</span><span style="color:#D4D4D4;">; </span><span style="color:#569CD6;">set</span><span style="color:#D4D4D4;">; }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;">  // Property&#39;s type is [InternalUse], so properties using that type are also internal.</span></span>
<span class="line"><span style="color:#569CD6;">  public</span><span style="color:#4EC9B0;"> Department</span><span style="color:#9CDCFE;"> Department</span><span style="color:#D4D4D4;"> { </span><span style="color:#569CD6;">get</span><span style="color:#D4D4D4;">; </span><span style="color:#569CD6;">set</span><span style="color:#D4D4D4;">; }</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">[</span><span style="color:#4EC9B0;">InternalUse</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#569CD6;">public</span><span style="color:#569CD6;"> class</span><span style="color:#4EC9B0;"> Department</span></span>
<span class="line"><span style="color:#D4D4D4;">{</span></span>
<span class="line"><span style="color:#6A9955;">  // All properties on an [InternalUse] type are non-exposed,</span></span>
<span class="line"><span style="color:#6A9955;">  // since the parent type is not exposed.</span></span>
<span class="line"><span style="color:#569CD6;">  public</span><span style="color:#569CD6;"> string</span><span style="color:#9CDCFE;"> Name</span><span style="color:#D4D4D4;"> { </span><span style="color:#569CD6;">get</span><span style="color:#D4D4D4;">; </span><span style="color:#569CD6;">set</span><span style="color:#D4D4D4;">; }</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span></code></pre></div><h3 id="read-only-properties" tabindex="-1">Read-Only Properties <a class="header-anchor" href="#read-only-properties" aria-label="Permalink to &quot;Read-Only Properties&quot;">​</a></h3><p>A property in Coalesce can be made read-only in any of the following ways:</p><div class="language-c#"><button title="Copy Code" class="copy"></button><span class="lang">c#</span><pre class="shiki dark-plus vp-code"><code><span class="line"><span style="color:#C586C0;">using</span><span style="color:#4EC9B0;"> IntelliTect</span><span style="color:#D4D4D4;">.</span><span style="color:#4EC9B0;">Coalesce</span><span style="color:#D4D4D4;">.</span><span style="color:#4EC9B0;">DataAnnotations</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"><span style="color:#C586C0;">using</span><span style="color:#4EC9B0;"> System</span><span style="color:#D4D4D4;">.</span><span style="color:#4EC9B0;">ComponentModel</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"><span style="color:#569CD6;">public</span><span style="color:#569CD6;"> class</span><span style="color:#4EC9B0;"> Employee</span></span>
<span class="line"><span style="color:#D4D4D4;">{</span></span>
<span class="line"><span style="color:#6A9955;">  // A property with a [Read] attribute but no [Edit] attribute is read-only:</span></span>
<span class="line"><span style="color:#D4D4D4;">  [</span><span style="color:#4EC9B0;">Read</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#569CD6;">  public</span><span style="color:#569CD6;"> string</span><span style="color:#9CDCFE;"> Name</span><span style="color:#D4D4D4;"> { </span><span style="color:#569CD6;">get</span><span style="color:#D4D4D4;">; </span><span style="color:#569CD6;">set</span><span style="color:#D4D4D4;">; }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;">  // Payroll users and HR users can read this property. Nobody can edit it:</span></span>
<span class="line"><span style="color:#D4D4D4;">  [</span><span style="color:#4EC9B0;">Read</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;Payroll,HR&quot;</span><span style="color:#D4D4D4;">)]</span></span>
<span class="line"><span style="color:#569CD6;">  public</span><span style="color:#569CD6;"> decimal</span><span style="color:#9CDCFE;"> Salary</span><span style="color:#D4D4D4;"> { </span><span style="color:#569CD6;">get</span><span style="color:#D4D4D4;">; </span><span style="color:#569CD6;">set</span><span style="color:#D4D4D4;">; }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;">  // Using System.ComponentModel.ReadOnlyAttribute:</span></span>
<span class="line"><span style="color:#D4D4D4;">  [</span><span style="color:#4EC9B0;">ReadOnly</span><span style="color:#D4D4D4;">(</span><span style="color:#569CD6;">true</span><span style="color:#D4D4D4;">)]</span></span>
<span class="line"><span style="color:#569CD6;">  public</span><span style="color:#4EC9B0;"> DateTime</span><span style="color:#9CDCFE;"> BirthDate</span><span style="color:#D4D4D4;"> { </span><span style="color:#569CD6;">get</span><span style="color:#D4D4D4;">; </span><span style="color:#569CD6;">set</span><span style="color:#D4D4D4;">; }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;">  // Non-public setter:</span></span>
<span class="line"><span style="color:#569CD6;">  public</span><span style="color:#4EC9B0;"> DateTime</span><span style="color:#9CDCFE;"> StartDate</span><span style="color:#D4D4D4;"> { </span><span style="color:#569CD6;">get</span><span style="color:#D4D4D4;">; </span><span style="color:#569CD6;">internal</span><span style="color:#569CD6;"> set</span><span style="color:#D4D4D4;">; }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;">  // No setter:</span></span>
<span class="line"><span style="color:#569CD6;">  public</span><span style="color:#569CD6;"> string</span><span style="color:#9CDCFE;"> EmploymentDuration</span><span style="color:#D4D4D4;"> =&gt; (</span><span style="color:#9CDCFE;">DateTime</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">Now</span><span style="color:#D4D4D4;"> - </span><span style="color:#9CDCFE;">StartDate</span><span style="color:#D4D4D4;">).</span><span style="color:#DCDCAA;">ToString</span><span style="color:#D4D4D4;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;">  // Edits denied:</span></span>
<span class="line"><span style="color:#D4D4D4;">  [</span><span style="color:#4EC9B0;">Edit</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">SecurityPermissionLevels</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">DenyAll</span><span style="color:#D4D4D4;">)]</span></span>
<span class="line"><span style="color:#569CD6;">  public</span><span style="color:#569CD6;"> string</span><span style="color:#9CDCFE;"> EmployeeNumber</span><span style="color:#D4D4D4;"> { </span><span style="color:#569CD6;">get</span><span style="color:#D4D4D4;">; </span><span style="color:#569CD6;">set</span><span style="color:#D4D4D4;">; }</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span></code></pre></div><h3 id="role-restrictions" tabindex="-1">Role Restrictions <a class="header-anchor" href="#role-restrictions" aria-label="Permalink to &quot;Role Restrictions&quot;">​</a></h3><p>Reading and writing a property in Coalesce can be restricted by roles:</p><div class="language-c#"><button title="Copy Code" class="copy"></button><span class="lang">c#</span><pre class="shiki dark-plus vp-code"><code><span class="line"><span style="color:#C586C0;">using</span><span style="color:#4EC9B0;"> IntelliTect</span><span style="color:#D4D4D4;">.</span><span style="color:#4EC9B0;">Coalesce</span><span style="color:#D4D4D4;">.</span><span style="color:#4EC9B0;">DataAnnotations</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"><span style="color:#569CD6;">public</span><span style="color:#569CD6;"> class</span><span style="color:#4EC9B0;"> Employee</span></span>
<span class="line"><span style="color:#D4D4D4;">{</span></span>
<span class="line"><span style="color:#6A9955;">  // A property with no attributes is readable and writable without restriction</span></span>
<span class="line"><span style="color:#569CD6;">  public</span><span style="color:#569CD6;"> string</span><span style="color:#9CDCFE;"> Name</span><span style="color:#D4D4D4;"> { </span><span style="color:#569CD6;">get</span><span style="color:#D4D4D4;">; </span><span style="color:#569CD6;">set</span><span style="color:#D4D4D4;">; }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;">  // When a [Read] and [Edit] attributes are both present,</span></span>
<span class="line"><span style="color:#6A9955;">  // the read roles are required for edits in addition to any edit roles.</span></span>
<span class="line"><span style="color:#6A9955;">  // Property is only readable by Payroll &amp; HR,</span></span>
<span class="line"><span style="color:#6A9955;">  // and is also only editable by Payroll &amp; HR.</span></span>
<span class="line"><span style="color:#D4D4D4;">  [</span><span style="color:#4EC9B0;">Read</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;Payroll,HR&quot;</span><span style="color:#D4D4D4;">), </span><span style="color:#4EC9B0;">Edit</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#569CD6;">  public</span><span style="color:#4EC9B0;"> DateTime</span><span style="color:#9CDCFE;"> BirthDate</span><span style="color:#D4D4D4;"> { </span><span style="color:#569CD6;">get</span><span style="color:#D4D4D4;">; </span><span style="color:#569CD6;">set</span><span style="color:#D4D4D4;">; }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;">  // Property is readable by Payroll and HR, and editable only by Payroll.</span></span>
<span class="line"><span style="color:#D4D4D4;">  [</span><span style="color:#4EC9B0;">Read</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;Payroll&quot;</span><span style="color:#D4D4D4;">, </span><span style="color:#CE9178;">&quot;HR&quot;</span><span style="color:#D4D4D4;">), </span><span style="color:#4EC9B0;">Edit</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;Payroll&quot;</span><span style="color:#D4D4D4;">)]</span></span>
<span class="line"><span style="color:#569CD6;">  public</span><span style="color:#569CD6;"> decimal</span><span style="color:#9CDCFE;"> Salary</span><span style="color:#D4D4D4;"> { </span><span style="color:#569CD6;">get</span><span style="color:#D4D4D4;">; </span><span style="color:#569CD6;">set</span><span style="color:#D4D4D4;">; }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;">  // Property is readable by Payroll, and editable only by a user who is both Payroll AND HR.</span></span>
<span class="line"><span style="color:#D4D4D4;">  [</span><span style="color:#4EC9B0;">Read</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;Payroll&quot;</span><span style="color:#D4D4D4;">), </span><span style="color:#4EC9B0;">Edit</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;HR&quot;</span><span style="color:#D4D4D4;">)]</span></span>
<span class="line"><span style="color:#569CD6;">  public</span><span style="color:#4EC9B0;"> DateTime</span><span style="color:#9CDCFE;"> StartDate</span><span style="color:#D4D4D4;"> { </span><span style="color:#569CD6;">get</span><span style="color:#D4D4D4;">; </span><span style="color:#569CD6;">set</span><span style="color:#D4D4D4;">; }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;">  // Init-only properties on entities can only be set by the first /save of the entity.</span></span>
<span class="line"><span style="color:#569CD6;">  public</span><span style="color:#569CD6;"> string</span><span style="color:#9CDCFE;"> EmployeeNumber</span><span style="color:#D4D4D4;"> { </span><span style="color:#569CD6;">get</span><span style="color:#D4D4D4;">; </span><span style="color:#569CD6;">init</span><span style="color:#D4D4D4;">; }</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span></code></pre></div><p>A few of the examples above point out that when a property is restricted for reading by roles, those roles are also required when editing that property. This is because it usually doesn&#39;t make sense for a user to change a value when they have no way of knowing what the original value was. If you have a situation where a property should be editable without knowing the original value, use a custom method on the model to accept and set the new value.</p><h3 id="custom-restrictions" tabindex="-1">Custom Restrictions <a class="header-anchor" href="#custom-restrictions" aria-label="Permalink to &quot;Custom Restrictions&quot;">​</a></h3><p><code>IntelliTect.Coalesce.DataAnnotations.RestrictAttribute&lt;T&gt;</code></p><p>In addition to <a href="/Coalesce/modeling/model-components/attributes/security-attribute.html">role-based</a> property restrictions, you can also define property restrictions that can execute custom code for each model instance if your logic require more nuanced decisions than can be made with roles.</p><div class="language-c#"><button title="Copy Code" class="copy"></button><span class="lang">c#</span><pre class="shiki dark-plus vp-code"><code><span class="line"><span style="color:#C586C0;">using</span><span style="color:#4EC9B0;"> IntelliTect</span><span style="color:#D4D4D4;">.</span><span style="color:#4EC9B0;">Coalesce</span><span style="color:#D4D4D4;">.</span><span style="color:#4EC9B0;">DataAnnotations</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"><span style="color:#569CD6;">public</span><span style="color:#569CD6;"> class</span><span style="color:#4EC9B0;"> Employee</span><span style="color:#D4D4D4;"> </span></span>
<span class="line"><span style="color:#D4D4D4;">{</span></span>
<span class="line"><span style="color:#569CD6;">  public</span><span style="color:#569CD6;"> int</span><span style="color:#9CDCFE;"> Id</span><span style="color:#D4D4D4;"> { </span><span style="color:#569CD6;">get</span><span style="color:#D4D4D4;">; </span><span style="color:#569CD6;">set</span><span style="color:#D4D4D4;">; }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">  [</span><span style="color:#4EC9B0;">Read</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#569CD6;">  public</span><span style="color:#569CD6;"> string</span><span style="color:#9CDCFE;"> UserId</span><span style="color:#D4D4D4;"> { </span><span style="color:#569CD6;">get</span><span style="color:#D4D4D4;">; </span><span style="color:#569CD6;">set</span><span style="color:#D4D4D4;">; }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">  [</span><span style="color:#4EC9B0;">Restrict</span><span style="color:#D4D4D4;">&lt;</span><span style="color:#4EC9B0;">SalaryRestriction</span><span style="color:#D4D4D4;">&gt;]</span></span>
<span class="line"><span style="color:#569CD6;">  public</span><span style="color:#569CD6;"> decimal</span><span style="color:#9CDCFE;"> Salary</span><span style="color:#D4D4D4;"> { </span><span style="color:#569CD6;">get</span><span style="color:#D4D4D4;">; </span><span style="color:#569CD6;">set</span><span style="color:#D4D4D4;">; }</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6;">public</span><span style="color:#569CD6;"> class</span><span style="color:#4EC9B0;"> SalaryRestriction</span><span style="color:#D4D4D4;">(</span><span style="color:#4EC9B0;">MyUserService</span><span style="color:#9CDCFE;"> userService</span><span style="color:#D4D4D4;">) : </span><span style="color:#4EC9B0;">IPropertyRestriction</span><span style="color:#D4D4D4;">&lt;</span><span style="color:#4EC9B0;">Employee</span><span style="color:#D4D4D4;">&gt;</span></span>
<span class="line"><span style="color:#D4D4D4;">{</span></span>
<span class="line"><span style="color:#569CD6;">  public</span><span style="color:#569CD6;"> bool</span><span style="color:#DCDCAA;"> UserCanRead</span><span style="color:#D4D4D4;">(</span><span style="color:#4EC9B0;">IMappingContext</span><span style="color:#9CDCFE;"> context</span><span style="color:#D4D4D4;">, </span><span style="color:#569CD6;">string</span><span style="color:#9CDCFE;"> propertyName</span><span style="color:#D4D4D4;">, </span><span style="color:#4EC9B0;">Employee</span><span style="color:#9CDCFE;"> model</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">    =&gt; </span><span style="color:#9CDCFE;">context</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">User</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">GetUserId</span><span style="color:#D4D4D4;">() == </span><span style="color:#9CDCFE;">model</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">UserId</span><span style="color:#D4D4D4;"> || </span><span style="color:#9CDCFE;">userService</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">IsPayroll</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">context</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">User</span><span style="color:#D4D4D4;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6;">  public</span><span style="color:#569CD6;"> bool</span><span style="color:#DCDCAA;"> UserCanWrite</span><span style="color:#D4D4D4;">(</span><span style="color:#4EC9B0;">IMappingContext</span><span style="color:#9CDCFE;"> context</span><span style="color:#D4D4D4;">, </span><span style="color:#569CD6;">string</span><span style="color:#9CDCFE;"> propertyName</span><span style="color:#D4D4D4;">, </span><span style="color:#4EC9B0;">Employee</span><span style="color:#9CDCFE;"> model</span><span style="color:#D4D4D4;">, </span><span style="color:#569CD6;">object</span><span style="color:#9CDCFE;"> incomingValue</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">    =&gt; </span><span style="color:#9CDCFE;">userService</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">IsPayroll</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">context</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">User</span><span style="color:#D4D4D4;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6;">  public</span><span style="color:#569CD6;"> bool</span><span style="color:#DCDCAA;"> UserCanFilter</span><span style="color:#D4D4D4;">(</span><span style="color:#4EC9B0;">IMappingContext</span><span style="color:#9CDCFE;"> context</span><span style="color:#D4D4D4;">, </span><span style="color:#569CD6;">string</span><span style="color:#9CDCFE;"> propertyName</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">    =&gt; </span><span style="color:#9CDCFE;">userService</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">IsPayroll</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">context</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">User</span><span style="color:#D4D4D4;">);</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span></code></pre></div><p>Restriction classes support dependency injection, so you can inject any supplemental services needed to make a determination.</p><p>The <code>UserCanRead</code> method controls whether values of the restricted property will be mapped from model instances to the generated DTO. Similarly, <code>UserCanWrite</code> controls whether the property can be mapped back to the model instance from the generated DTO.</p><p>The <code>UserCanFilter</code> method has a default implementation that returns <code>false</code>, but can be implemented if there is an appropriate, instance-agnostic way to determine if a user can sort, search, or filter values of that property.</p><p>Multiple different restrictions can be placed on a single property; all of them must succeed for the operation to be permitted. Restrictions also stack on top of role attribute restrictions (<code>[Read]</code> and <code>[Edit]</code>).</p><h2 id="row-level-security" tabindex="-1">Row-level Security <a class="header-anchor" href="#row-level-security" aria-label="Permalink to &quot;Row-level Security&quot;">​</a></h2><h3 id="data-sources" tabindex="-1">Data Sources <a class="header-anchor" href="#data-sources" aria-label="Permalink to &quot;Data Sources&quot;">​</a></h3><p>In Coalesce, <a href="/Coalesce/modeling/model-components/data-sources.html">Data Sources</a> are the mechanism that you can extend to implement row-level security on your <a href="/Coalesce/modeling/model-types/crud.html">CRUD Models</a>.</p><p>Data Sources are used when fetching results for <code>/get</code>, <code>/list</code>, and <code>/count</code> endpoints, and when fetching the target or result of a <code>/save</code>, <code>/bulkSave</code>, or <code>/delete</code>, and when fetching the invocation target of an <a href="/Coalesce/modeling/model-components/methods.html#instance-methods">Instance Method</a>.</p><p>By default, your models will be fetched using the <a href="/Coalesce/modeling/model-components/data-sources.html#standard-data-source">Standard Data Source</a>, but you can declare a custom default data source for each of your models to override this default functionality. The default functionality here includes the <a href="/Coalesce/modeling/model-components/data-sources.html#default-loading-behavior">default loading behavior</a>, a feature where the Standard Data Source automatically includes the immediate relationships of requested models. This can be suppressed by overriding the <code>GetQuery</code> method on your custom data source and not calling the base method, or by placing <code>[Read(NoAutoInclude = true)]</code> on classes or navigation properties that you do not want automatically included.</p><p>For most use cases, all your security rules will be implemented in the <a href="/Coalesce/modeling/model-components/data-sources.html#member-getquery">GetQuery/GetQueryAsync</a> method. This is the most foundational method of the data source that all other functions in the data source build upon. Any predicates applied to the query of a type&#39;s default data source will affect all of the type&#39;s generated API endpoints (except for static custom methods).</p><p>There are a few different techniques that you can use to apply filtering in a data source, each one working for a specific use case. The example below includes an example of each technique.</p><h4 id="query-predicates" tabindex="-1">Query Predicates <a class="header-anchor" href="#query-predicates" aria-label="Permalink to &quot;Query Predicates&quot;">​</a></h4><p>The <strong>Query Predicates</strong> technique involves applying a <code>.Where()</code> predicate to your query to filter the root entities that are returned by the query using some database-executed logic. This is a form of row-level security and can be used to only include a record based on the values of that record in the database.</p><h4 id="conditional-includes" tabindex="-1">Conditional Includes <a class="header-anchor" href="#conditional-includes" aria-label="Permalink to &quot;Conditional Includes&quot;">​</a></h4><p>The <strong>Conditional Includes</strong> technique involves conditionally appending <code>.Include()</code> calls to your query only when some server-executed criteria is met. Usually this involves checking the roles of a user and only including a navigation property if the user is in the requisite role. This technique cannot be used with database-executed logic and is therefore behaves more like table-level security than row-level security.</p><h4 id="filtered-includes" tabindex="-1">Filtered Includes <a class="header-anchor" href="#filtered-includes" aria-label="Permalink to &quot;Filtered Includes&quot;">​</a></h4><p>The <strong>Filtered Includes</strong> technique involves using <a href="https://learn.microsoft.com/en-us/ef/core/querying/related-data/eager#filtered-include" target="_blank" rel="noreferrer">EF Core filtered includes</a> to apply database-executed logic to filter the rows of child collection navigation properties.</p><p>EF filtered Includes <strong>cannot</strong> be used to apply database-executed filters to <em>reference</em> navigation properties due to <a href="https://github.com/dotnet/efcore/issues/24422" target="_blank" rel="noreferrer">lack of EF support</a> - see the sections below on <a href="#transform-results">transform results</a> and <a href="#ef-global-query-filters">global query filters</a> for two possible solutions.</p><p>A complex example using all three of the above techniques:</p><div class="language-c#"><button title="Copy Code" class="copy"></button><span class="lang">c#</span><pre class="shiki dark-plus vp-code"><code><span class="line"><span style="color:#569CD6;">public</span><span style="color:#569CD6;"> class</span><span style="color:#4EC9B0;"> Employee</span></span>
<span class="line"><span style="color:#D4D4D4;">{</span></span>
<span class="line"><span style="color:#569CD6;">  public</span><span style="color:#569CD6;"> int</span><span style="color:#9CDCFE;"> EmployeeId</span><span style="color:#D4D4D4;"> { </span><span style="color:#569CD6;">get</span><span style="color:#D4D4D4;">; </span><span style="color:#569CD6;">set</span><span style="color:#D4D4D4;">; }</span></span>
<span class="line"><span style="color:#569CD6;">  public</span><span style="color:#569CD6;"> bool</span><span style="color:#9CDCFE;"> IsIntern</span><span style="color:#D4D4D4;"> { </span><span style="color:#569CD6;">get</span><span style="color:#D4D4D4;">; </span><span style="color:#569CD6;">set</span><span style="color:#D4D4D4;">; }</span></span>
<span class="line"><span style="color:#569CD6;">  public</span><span style="color:#4EC9B0;"> List</span><span style="color:#D4D4D4;">&lt;</span><span style="color:#4EC9B0;">DepartmentMember</span><span style="color:#D4D4D4;">&gt; </span><span style="color:#9CDCFE;">DepartmentMembers</span><span style="color:#D4D4D4;"> { </span><span style="color:#569CD6;">get</span><span style="color:#D4D4D4;">; </span><span style="color:#569CD6;">set</span><span style="color:#D4D4D4;">; }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;">  // Override the default data source for Employee with a custom one:</span></span>
<span class="line"><span style="color:#D4D4D4;">  [</span><span style="color:#4EC9B0;">DefaultDataSource</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#569CD6;">  public</span><span style="color:#569CD6;"> class</span><span style="color:#4EC9B0;"> DefaultSource</span><span style="color:#D4D4D4;"> : </span><span style="color:#4EC9B0;">StandardDataSource</span><span style="color:#D4D4D4;">&lt;</span><span style="color:#4EC9B0;">Employee</span><span style="color:#D4D4D4;">, </span><span style="color:#4EC9B0;">AppDbContext</span><span style="color:#D4D4D4;">&gt;</span></span>
<span class="line"><span style="color:#D4D4D4;">  {</span></span>
<span class="line"><span style="color:#569CD6;">    public</span><span style="color:#DCDCAA;"> DefaultSource</span><span style="color:#D4D4D4;">(</span><span style="color:#4EC9B0;">CrudContext</span><span style="color:#D4D4D4;">&lt;</span><span style="color:#4EC9B0;">AppDbContext</span><span style="color:#D4D4D4;">&gt; </span><span style="color:#9CDCFE;">context</span><span style="color:#D4D4D4;">) : </span><span style="color:#569CD6;">base</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">context</span><span style="color:#D4D4D4;">) { }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6;">    public</span><span style="color:#569CD6;"> override</span><span style="color:#4EC9B0;"> IQueryable</span><span style="color:#D4D4D4;">&lt;</span><span style="color:#4EC9B0;">Employee</span><span style="color:#D4D4D4;">&gt; </span><span style="color:#DCDCAA;">GetQuery</span><span style="color:#D4D4D4;">(</span><span style="color:#4EC9B0;">IDataSourceParameters</span><span style="color:#9CDCFE;"> parameters</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#4EC9B0;">      IQueryable</span><span style="color:#D4D4D4;">&lt;</span><span style="color:#4EC9B0;">Employee</span><span style="color:#D4D4D4;">&gt; </span><span style="color:#9CDCFE;">query</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">Db</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">Employees</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;">      // TECHNIQUE: Conditional Includes - subset child objects using server-executed logic:</span></span>
<span class="line"><span style="color:#C586C0;">      if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">User</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">IsInRole</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;HR&quot;</span><span style="color:#D4D4D4;">)) {</span></span>
<span class="line"><span style="color:#6A9955;">        // HR can see everything. Return early so they are not subjected to the other filters:</span></span>
<span class="line"><span style="color:#C586C0;">        return</span><span style="color:#9CDCFE;"> query</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">Include</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">e</span><span style="color:#D4D4D4;"> =&gt; </span><span style="color:#9CDCFE;">e</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">DepartmentMembers</span><span style="color:#D4D4D4;">).</span><span style="color:#DCDCAA;">ThenInclude</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">dm</span><span style="color:#D4D4D4;"> =&gt; </span><span style="color:#9CDCFE;">dm</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">Department</span><span style="color:#D4D4D4;">);</span></span>
<span class="line"><span style="color:#D4D4D4;">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;">      // TECHNIQUE: Query Predicates - subset root objects using database-executed logic:</span></span>
<span class="line"><span style="color:#569CD6;">      int</span><span style="color:#9CDCFE;"> employeeId</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">User</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">GetEmployeeId</span><span style="color:#D4D4D4;">();</span></span>
<span class="line"><span style="color:#9CDCFE;">      query</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">query</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">Where</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">e</span><span style="color:#D4D4D4;"> =&gt;</span></span>
<span class="line"><span style="color:#6A9955;">          // Anyone can see interns</span></span>
<span class="line"><span style="color:#9CDCFE;">          e</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">IsIntern</span><span style="color:#D4D4D4;"> ||</span></span>
<span class="line"><span style="color:#6A9955;">          // Otherwise, a user can only see employees in their own departments:</span></span>
<span class="line"><span style="color:#9CDCFE;">          e</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">DepartmentMembers</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">Any</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">dm</span><span style="color:#D4D4D4;"> =&gt; </span><span style="color:#9CDCFE;">dm</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">Department</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">DepartmentMembers</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">Any</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">u</span><span style="color:#D4D4D4;"> =&gt; </span><span style="color:#9CDCFE;">u</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">EmployeeId</span><span style="color:#D4D4D4;"> == </span><span style="color:#9CDCFE;">employeeId</span><span style="color:#D4D4D4;">))</span></span>
<span class="line"><span style="color:#D4D4D4;">        );</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;">      // TECHNIQUE: EF Core Filtered Includes - subset collections using database-executed logic.</span></span>
<span class="line"><span style="color:#6A9955;">      // Include the departments of employees, but only those that the current user is a member of.</span></span>
<span class="line"><span style="color:#9CDCFE;">      query</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">query</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">Include</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">e</span><span style="color:#D4D4D4;"> =&gt; </span><span style="color:#9CDCFE;">e</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">DepartmentMembers</span></span>
<span class="line"><span style="color:#D4D4D4;">        .</span><span style="color:#DCDCAA;">Where</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">dm</span><span style="color:#D4D4D4;"> =&gt; </span><span style="color:#9CDCFE;">dm</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">Department</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">DepartmentMembers</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">Any</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">u</span><span style="color:#D4D4D4;"> =&gt; </span><span style="color:#9CDCFE;">u</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">EmployeeId</span><span style="color:#D4D4D4;"> == </span><span style="color:#9CDCFE;">employeeId</span><span style="color:#D4D4D4;">)))</span></span>
<span class="line"><span style="color:#D4D4D4;">        .</span><span style="color:#DCDCAA;">ThenInclude</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">dm</span><span style="color:#D4D4D4;"> =&gt; </span><span style="color:#9CDCFE;">dm</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">Department</span><span style="color:#D4D4D4;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C586C0;">      return</span><span style="color:#9CDCFE;"> query</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"><span style="color:#D4D4D4;">    }</span></span>
<span class="line"><span style="color:#D4D4D4;">  }</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6;">public</span><span style="color:#569CD6;"> class</span><span style="color:#4EC9B0;"> Department</span></span>
<span class="line"><span style="color:#D4D4D4;">{</span></span>
<span class="line"><span style="color:#569CD6;">  public</span><span style="color:#569CD6;"> int</span><span style="color:#9CDCFE;"> DepartmentId</span><span style="color:#D4D4D4;"> { </span><span style="color:#569CD6;">get</span><span style="color:#D4D4D4;">; </span><span style="color:#569CD6;">set</span><span style="color:#D4D4D4;">; }</span></span>
<span class="line"><span style="color:#569CD6;">  public</span><span style="color:#569CD6;"> string</span><span style="color:#9CDCFE;"> Name</span><span style="color:#D4D4D4;"> { </span><span style="color:#569CD6;">get</span><span style="color:#D4D4D4;">; </span><span style="color:#569CD6;">set</span><span style="color:#D4D4D4;">; }</span></span>
<span class="line"><span style="color:#569CD6;">  public</span><span style="color:#4EC9B0;"> List</span><span style="color:#D4D4D4;">&lt;</span><span style="color:#4EC9B0;">DepartmentMember</span><span style="color:#D4D4D4;">&gt; </span><span style="color:#9CDCFE;">DepartmentMembers</span><span style="color:#D4D4D4;"> { </span><span style="color:#569CD6;">get</span><span style="color:#D4D4D4;">; </span><span style="color:#569CD6;">set</span><span style="color:#D4D4D4;">; }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;">  // Override the default data source for Department with a custom one:</span></span>
<span class="line"><span style="color:#D4D4D4;">  [</span><span style="color:#4EC9B0;">DefaultDataSource</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#569CD6;">  public</span><span style="color:#569CD6;"> class</span><span style="color:#4EC9B0;"> DefaultSource</span><span style="color:#D4D4D4;"> : </span><span style="color:#4EC9B0;">StandardDataSource</span><span style="color:#D4D4D4;">&lt;</span><span style="color:#4EC9B0;">Department</span><span style="color:#D4D4D4;">, </span><span style="color:#4EC9B0;">AppDbContext</span><span style="color:#D4D4D4;">&gt;</span></span>
<span class="line"><span style="color:#D4D4D4;">  {</span></span>
<span class="line"><span style="color:#569CD6;">    public</span><span style="color:#DCDCAA;"> DefaultSource</span><span style="color:#D4D4D4;">(</span><span style="color:#4EC9B0;">CrudContext</span><span style="color:#D4D4D4;">&lt;</span><span style="color:#4EC9B0;">AppDbContext</span><span style="color:#D4D4D4;">&gt; </span><span style="color:#9CDCFE;">context</span><span style="color:#D4D4D4;">) : </span><span style="color:#569CD6;">base</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">context</span><span style="color:#D4D4D4;">) { }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6;">    public</span><span style="color:#569CD6;"> override</span><span style="color:#4EC9B0;"> IQueryable</span><span style="color:#D4D4D4;">&lt;</span><span style="color:#4EC9B0;">Department</span><span style="color:#D4D4D4;">&gt; </span><span style="color:#DCDCAA;">GetQuery</span><span style="color:#D4D4D4;">(</span><span style="color:#4EC9B0;">IDataSourceParameters</span><span style="color:#9CDCFE;"> parameters</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#4EC9B0;">      IQueryable</span><span style="color:#D4D4D4;">&lt;</span><span style="color:#4EC9B0;">Department</span><span style="color:#D4D4D4;">&gt; </span><span style="color:#9CDCFE;">query</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">Db</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">Departments</span></span>
<span class="line"><span style="color:#D4D4D4;">        .</span><span style="color:#DCDCAA;">Include</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">e</span><span style="color:#D4D4D4;"> =&gt; </span><span style="color:#9CDCFE;">e</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">DepartmentMembers</span><span style="color:#D4D4D4;">).</span><span style="color:#DCDCAA;">ThenInclude</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">dm</span><span style="color:#D4D4D4;"> =&gt; </span><span style="color:#9CDCFE;">dm</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">Employee</span><span style="color:#D4D4D4;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C586C0;">      if</span><span style="color:#D4D4D4;"> (!</span><span style="color:#9CDCFE;">User</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">IsInRole</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;HR&quot;</span><span style="color:#D4D4D4;">))</span></span>
<span class="line"><span style="color:#D4D4D4;">      {</span></span>
<span class="line"><span style="color:#6A9955;">        // Non-HR users can only see their own departments:</span></span>
<span class="line"><span style="color:#9CDCFE;">        query</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">query</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">Where</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">d</span><span style="color:#D4D4D4;"> =&gt; </span><span style="color:#9CDCFE;">d</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">DepartmentMembers</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">Any</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">dm</span><span style="color:#D4D4D4;"> =&gt; </span><span style="color:#9CDCFE;">dm</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">EmployeeId</span><span style="color:#D4D4D4;"> == </span><span style="color:#9CDCFE;">User</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">GetEmployeeId</span><span style="color:#D4D4D4;">()));</span></span>
<span class="line"><span style="color:#D4D4D4;">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C586C0;">      return</span><span style="color:#9CDCFE;"> query</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"><span style="color:#D4D4D4;">    }</span></span>
<span class="line"><span style="color:#D4D4D4;">  }</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;">// Only HR can directly read or modify DepartmentMember records.</span></span>
<span class="line"><span style="color:#D4D4D4;">[</span><span style="color:#4EC9B0;">Read</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;HR&quot;</span><span style="color:#D4D4D4;">), </span><span style="color:#4EC9B0;">Create</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;HR&quot;</span><span style="color:#D4D4D4;">), </span><span style="color:#4EC9B0;">Edit</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;HR&quot;</span><span style="color:#D4D4D4;">), </span><span style="color:#4EC9B0;">Delete</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;HR&quot;</span><span style="color:#D4D4D4;">)]</span></span>
<span class="line"><span style="color:#569CD6;">public</span><span style="color:#569CD6;"> class</span><span style="color:#4EC9B0;"> DepartmentMember</span></span>
<span class="line"><span style="color:#D4D4D4;">{</span></span>
<span class="line"><span style="color:#569CD6;">  public</span><span style="color:#569CD6;"> int</span><span style="color:#9CDCFE;"> Id</span><span style="color:#D4D4D4;"> { </span><span style="color:#569CD6;">get</span><span style="color:#D4D4D4;">; </span><span style="color:#569CD6;">set</span><span style="color:#D4D4D4;">; }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6;">  public</span><span style="color:#569CD6;"> int</span><span style="color:#9CDCFE;"> DepartmentId</span><span style="color:#D4D4D4;"> { </span><span style="color:#569CD6;">get</span><span style="color:#D4D4D4;">; </span><span style="color:#569CD6;">set</span><span style="color:#D4D4D4;">; }</span></span>
<span class="line"><span style="color:#569CD6;">  public</span><span style="color:#4EC9B0;"> Department</span><span style="color:#9CDCFE;"> Department</span><span style="color:#D4D4D4;"> { </span><span style="color:#569CD6;">get</span><span style="color:#D4D4D4;">; </span><span style="color:#569CD6;">set</span><span style="color:#D4D4D4;">; }</span></span>
<span class="line"><span style="color:#569CD6;">  public</span><span style="color:#569CD6;"> int</span><span style="color:#9CDCFE;"> EmployeeId</span><span style="color:#D4D4D4;"> { </span><span style="color:#569CD6;">get</span><span style="color:#D4D4D4;">; </span><span style="color:#569CD6;">set</span><span style="color:#D4D4D4;">; }</span></span>
<span class="line"><span style="color:#569CD6;">  public</span><span style="color:#4EC9B0;"> Employee</span><span style="color:#9CDCFE;"> Employee</span><span style="color:#D4D4D4;"> { </span><span style="color:#569CD6;">get</span><span style="color:#D4D4D4;">; </span><span style="color:#569CD6;">set</span><span style="color:#D4D4D4;">; }</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span></code></pre></div><h4 id="transform-results" tabindex="-1">Transform Results <a class="header-anchor" href="#transform-results" aria-label="Permalink to &quot;Transform Results&quot;">​</a></h4><p>There exists a fourth technique in Data Sources for applying filtered includes: the <a href="/Coalesce/modeling/model-components/data-sources.html#member-transformresults">TransformResultsAsync</a> method. Unlike the other techniques above that are performed in the <code>GetQuery</code> method and applied at the beginning of the data source query pipeline, <code>TransformResults</code> is applied at the very end of the process against the materialized results. It also only affects the responses from the generated <code>/get</code>, <code>/list</code>, <code>/save</code>, <code>/bulkSave</code>, and <code>/delete</code> endpoints - it has no bearing on the invocation target of <a href="/Coalesce/modeling/model-components/methods.html#instance-methods">instance methods</a>.</p><p>The primary purpose of <code>TransformResults</code> is to conditionally load navigation properties. This was very useful before EF Core introduced native <a href="#filtered-includes">filtered includes</a> for collection navigation properties, and is still useful for applying filtered includes to <em>reference</em> navigation properties since EF <a href="https://github.com/dotnet/efcore/issues/24422" target="_blank" rel="noreferrer">does not support this</a>. It can also be used for any kind of filtered includes if native EF filtered includes get translated into poorly-performant SQL, or it can be used to populate <a href="/Coalesce/modeling/model-types/external-types.html">external type</a> or other non-database-mapped properties on your entities.</p><p>The general technique for using <code>TransformResults</code> involves using <a href="https://learn.microsoft.com/en-us/ef/core/querying/related-data/explicit#explicit-loading" target="_blank" rel="noreferrer">EF Core Explicit Loading</a> to attach additional navigation properties to the result set, and then using Coalesce&#39;s <code>.IncludedSeparately()</code> method in the data source&#39;s <code>GetQuery</code> so that Coalesce can still build the correct <a href="/Coalesce/concepts/include-tree.html">Include Tree</a> to shape the serialization of your results.</p><div class="language-c#"><button title="Copy Code" class="copy"></button><span class="lang">c#</span><pre class="shiki dark-plus vp-code"><code><span class="line"><span style="color:#569CD6;">public</span><span style="color:#569CD6;"> class</span><span style="color:#4EC9B0;"> Employee</span></span>
<span class="line"><span style="color:#D4D4D4;">{</span></span>
<span class="line"><span style="color:#569CD6;">  public</span><span style="color:#569CD6;"> int</span><span style="color:#9CDCFE;"> EmployeeId</span><span style="color:#D4D4D4;"> { </span><span style="color:#569CD6;">get</span><span style="color:#D4D4D4;">; </span><span style="color:#569CD6;">set</span><span style="color:#D4D4D4;">; }</span></span>
<span class="line"><span style="color:#569CD6;">  public</span><span style="color:#569CD6;"> int</span><span style="color:#9CDCFE;"> ManagerId</span><span style="color:#D4D4D4;"> { </span><span style="color:#569CD6;">get</span><span style="color:#D4D4D4;">; </span><span style="color:#569CD6;">set</span><span style="color:#D4D4D4;">; }</span></span>
<span class="line"><span style="color:#569CD6;">  public</span><span style="color:#4EC9B0;"> Employee</span><span style="color:#9CDCFE;"> Manager</span><span style="color:#D4D4D4;"> { </span><span style="color:#569CD6;">get</span><span style="color:#D4D4D4;">; </span><span style="color:#569CD6;">set</span><span style="color:#D4D4D4;">; }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">  [</span><span style="color:#4EC9B0;">DefaultDataSource</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#569CD6;">  public</span><span style="color:#569CD6;"> class</span><span style="color:#4EC9B0;"> DefaultSource</span><span style="color:#D4D4D4;"> : </span><span style="color:#4EC9B0;">StandardDataSource</span><span style="color:#D4D4D4;">&lt;</span><span style="color:#4EC9B0;">Employee</span><span style="color:#D4D4D4;">, </span><span style="color:#4EC9B0;">AppDbContext</span><span style="color:#D4D4D4;">&gt;</span></span>
<span class="line"><span style="color:#D4D4D4;">  {</span></span>
<span class="line"><span style="color:#569CD6;">    public</span><span style="color:#DCDCAA;"> DefaultSource</span><span style="color:#D4D4D4;">(</span><span style="color:#4EC9B0;">CrudContext</span><span style="color:#D4D4D4;">&lt;</span><span style="color:#4EC9B0;">AppDbContext</span><span style="color:#D4D4D4;">&gt; </span><span style="color:#9CDCFE;">context</span><span style="color:#D4D4D4;">) : </span><span style="color:#569CD6;">base</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">context</span><span style="color:#D4D4D4;">) { }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6;">    public</span><span style="color:#569CD6;"> override</span><span style="color:#4EC9B0;"> IQueryable</span><span style="color:#D4D4D4;">&lt;</span><span style="color:#4EC9B0;">Employee</span><span style="color:#D4D4D4;">&gt; </span><span style="color:#DCDCAA;">GetQuery</span><span style="color:#D4D4D4;">(</span><span style="color:#4EC9B0;">IDataSourceParameters</span><span style="color:#9CDCFE;"> parameters</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#6A9955;">      // Use IncludedSeparately to instruct Coalesce that we&#39;re going to</span></span>
<span class="line"><span style="color:#6A9955;">      // manually populate the Manager, and that it should be mapped to the result DTOs</span></span>
<span class="line"><span style="color:#6A9955;">      // despite not being eagerly loaded with EF&#39;s .Include() method.</span></span>
<span class="line"><span style="color:#D4D4D4;">      =&gt; </span><span style="color:#9CDCFE;">Db</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">Employees</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">IncludedSeparately</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">e</span><span style="color:#D4D4D4;"> =&gt; </span><span style="color:#9CDCFE;">e</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">Manager</span><span style="color:#D4D4D4;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6;">    public</span><span style="color:#569CD6;"> override</span><span style="color:#569CD6;"> async</span><span style="color:#4EC9B0;"> Task</span><span style="color:#DCDCAA;"> TransformResultsAsync</span><span style="color:#D4D4D4;">(</span></span>
<span class="line"><span style="color:#4EC9B0;">      IReadOnlyList</span><span style="color:#D4D4D4;">&lt;</span><span style="color:#4EC9B0;">Employee</span><span style="color:#D4D4D4;">&gt; </span><span style="color:#9CDCFE;">results</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#4EC9B0;">      IDataSourceParameters</span><span style="color:#9CDCFE;"> parameters</span></span>
<span class="line"><span style="color:#D4D4D4;">    )</span></span>
<span class="line"><span style="color:#D4D4D4;">    {</span></span>
<span class="line"><span style="color:#C586C0;">      foreach</span><span style="color:#D4D4D4;"> (</span><span style="color:#569CD6;">var</span><span style="color:#9CDCFE;"> employee</span><span style="color:#C586C0;"> in</span><span style="color:#9CDCFE;"> results</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">      {</span></span>
<span class="line"><span style="color:#6A9955;">        // Only load the employee&#39;s manager if the current logged in user is that manager.</span></span>
<span class="line"><span style="color:#C586C0;">        if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">employee</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">ManagerId</span><span style="color:#D4D4D4;"> == </span><span style="color:#9CDCFE;">User</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">GetEmployeeId</span><span style="color:#D4D4D4;">() &amp;&amp; </span><span style="color:#9CDCFE;">employee</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">Manager</span><span style="color:#569CD6;"> is</span><span style="color:#569CD6;"> null</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#569CD6;">          await</span><span style="color:#9CDCFE;"> Db</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">Employees</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">Where</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">e</span><span style="color:#D4D4D4;"> =&gt; </span><span style="color:#9CDCFE;">e</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">EmployeeId</span><span style="color:#D4D4D4;"> == </span><span style="color:#9CDCFE;">employee</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">ManagerId</span><span style="color:#D4D4D4;">).</span><span style="color:#DCDCAA;">LoadAsync</span><span style="color:#D4D4D4;">();</span></span>
<span class="line"><span style="color:#D4D4D4;">        }</span></span>
<span class="line"><span style="color:#D4D4D4;">      }</span></span>
<span class="line"><span style="color:#D4D4D4;">    }</span></span>
<span class="line"><span style="color:#D4D4D4;">  }</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span></code></pre></div><p>Alternatively, and indeed preferably, you can often formulate a query that does not use iteration and requires only a single database round-trip:</p><div class="language-c#"><button title="Copy Code" class="copy"></button><span class="lang">c#</span><pre class="shiki dark-plus vp-code"><code><span class="line"><span style="color:#569CD6;">public</span><span style="color:#569CD6;"> override</span><span style="color:#569CD6;"> async</span><span style="color:#4EC9B0;"> Task</span><span style="color:#DCDCAA;"> TransformResultsAsync</span><span style="color:#D4D4D4;">(</span></span>
<span class="line"><span style="color:#4EC9B0;">  IReadOnlyList</span><span style="color:#D4D4D4;">&lt;</span><span style="color:#4EC9B0;">Employee</span><span style="color:#D4D4D4;">&gt; </span><span style="color:#9CDCFE;">results</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#4EC9B0;">  IDataSourceParameters</span><span style="color:#9CDCFE;"> parameters</span></span>
<span class="line"><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">{</span></span>
<span class="line"><span style="color:#569CD6;">  var</span><span style="color:#9CDCFE;"> managerIds</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">results</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">Select</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">e</span><span style="color:#D4D4D4;"> =&gt; </span><span style="color:#9CDCFE;">e</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">ManagerId</span><span style="color:#D4D4D4;">).</span><span style="color:#DCDCAA;">ToList</span><span style="color:#D4D4D4;">();</span></span>
<span class="line"><span style="color:#569CD6;">  await</span><span style="color:#9CDCFE;"> Db</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">Employees</span></span>
<span class="line"><span style="color:#D4D4D4;">    .</span><span style="color:#DCDCAA;">Where</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">e</span><span style="color:#D4D4D4;"> =&gt; </span><span style="color:#9CDCFE;">managerIds</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">Contains</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">e</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">ManagerId</span><span style="color:#D4D4D4;">) &amp;&amp; </span><span style="color:#9CDCFE;">e</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">EmployeeId</span><span style="color:#D4D4D4;"> == </span><span style="color:#9CDCFE;">User</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">GetEmployeeId</span><span style="color:#D4D4D4;">())</span></span>
<span class="line"><span style="color:#D4D4D4;">    .</span><span style="color:#DCDCAA;">LoadAsync</span><span style="color:#D4D4D4;">();</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span></code></pre></div><h3 id="behaviors" tabindex="-1">Behaviors <a class="header-anchor" href="#behaviors" aria-label="Permalink to &quot;Behaviors&quot;">​</a></h3><p>In Coalesce, <a href="/Coalesce/modeling/model-components/behaviors.html">Behaviors</a> are the extension point to implement row-level security or other customizations of create/edit/delete operations on your <a href="/Coalesce/modeling/model-types/crud.html">CRUD Models</a>. Behaviors are implemented on top of data sources, meaning the client request will be rejected if the requested entity for modification cannot be loaded from the entity&#39;s default data source.</p><p>By default, each entity will use the <a href="/Coalesce/modeling/model-components/behaviors.html#behaviors">Standard Behaviors</a>, but you can declare a <a href="/Coalesce/modeling/model-components/behaviors.html#defining-behaviors">custom behaviors class</a> for each of your models to override this default functionality.</p><p>For most use cases, all your security rules will be implemented in the <a href="/Coalesce/modeling/model-components/behaviors.html#member-beforesaveasync">BeforeSave/BeforeSaveAsync</a> and <a href="/Coalesce/modeling/model-components/behaviors.html#member-beforedeleteasync">BeforeDelete/BeforeDeleteAsync</a> methods.</p><p>For a more complete explanation of everything you can do with behaviors, see the full <a href="/Coalesce/modeling/model-components/behaviors.html">Behaviors</a> documentation page.</p><h3 id="ef-global-query-filters" tabindex="-1">EF Global Query Filters <a class="header-anchor" href="#ef-global-query-filters" aria-label="Permalink to &quot;EF Global Query Filters&quot;">​</a></h3><p>Since Coalesce&#39;s data access layer is built on top of Entity Framework, you can also use <a href="https://learn.microsoft.com/en-us/ef/core/querying/filters" target="_blank" rel="noreferrer">Entity Framework&#39;s Global Query Filters</a> feature to apply row-level security.</p><p>This approach is less flexible than custom Coalesce data sources and has other <a href="https://learn.microsoft.com/en-us/ef/core/querying/filters#accessing-entity-with-query-filter-using-required-navigation" target="_blank" rel="noreferrer">drawbacks</a> as well, but on the other hand it has more absolute authority, is less susceptible to issues like inadvertently returning data through unfiltered navigation properties, and can sometimes require less work to implement than individual data sources.</p><p>Global Query Filters are also the only way to implement database-executed <a href="#filtered-includes">filtered includes</a> of <a href="https://learn.microsoft.com/en-us/ef/core/modeling/relationships/glossary" target="_blank" rel="noreferrer">reference navigation properties</a>, as there is no version of <code>.Include()</code> for reference navigation properties that allows a database-executed predicate to be applied. See <a href="https://github.com/dotnet/efcore/issues/24422" target="_blank" rel="noreferrer">this open issue</a> on EF Core.</p><h3 id="foreign-key-injection-vulnerabilities" tabindex="-1">Foreign Key Injection Vulnerabilities <a class="header-anchor" href="#foreign-key-injection-vulnerabilities" aria-label="Permalink to &quot;Foreign Key Injection Vulnerabilities&quot;">​</a></h3><p>When a user is saving a model with Coalesce, they can provide values for the model&#39;s foreign key properties. When this interaction takes place through a user interface, the user is not likely to produce a foreign key referencing an object that the user is not allowed to view.</p><p>A malicious user, however, is a different story. Imagine a user who is brute-forcing the <code>/save</code> endpoint on one of your entities, enumerating values of a foreign key. The may be trying to leak data through navigation property values returned by the response from the save, or they may be trying to inject their data into an object graph that they do not otherwise have access to.</p><p>If this scenario sounds like a plausible threat vector your application, be sure to perform sufficient <a href="#server-side-data-validation">validation</a> of incoming foreign keys to ensure that the user is allowed to use a particular foreign key value before saving it to your database.</p><p>Also consider making any required foreign keys that should not change for the lifetime of an entity into init-only properties (i.e. use the <code>init</code> accessor in C# instead of the <code>set</code> accessor). While this does not entirely solve the foreign key injection issue, it eliminates the need to validate that a user is not changing the parent of an object if such an operation is not desirable.</p><h2 id="server-side-data-validation" tabindex="-1">Server-side Data Validation <a class="header-anchor" href="#server-side-data-validation" aria-label="Permalink to &quot;Server-side Data Validation&quot;">​</a></h2><p>Coalesce, as of version 4, will by default perform server-side validation of incoming data using validation attributes.</p><p>Your database will also enforce any constraints (referential integrity, <code>not null</code>, check constraints, etc.), but errors produced by your database will manifest as exceptions, which are not user-friendly.</p><p>For any custom validation that cannot be implemented by attributes, you must implement that yourself for <a href="#saves-and-deletes">saves and deletes</a> or <a href="#custom-methods-and-services">custom methods</a>.</p><h3 id="attribute-validation" tabindex="-1">Attribute Validation <a class="header-anchor" href="#attribute-validation" aria-label="Permalink to &quot;Attribute Validation&quot;">​</a></h3><p>Historically, Coalesce did not provide any automatic, attribute-based validation of incoming data. As of Coalesce 4.0, automatic server side validation using <a href="https://learn.microsoft.com/en-us/dotnet/api/system.componentmodel.dataannotations.validationattribute" target="_blank" rel="noreferrer">ValidationAttribute</a>-derived attributes on your models is enabled by default.</p><p>In addition to any validation attributes present on your model properties and method parameters, there are some other rules that work similarly to the default validation in ASP.NET Core:</p><ul><li>The C# 11 <code>required</code> keyword also acts like a <code>RequiredAttribute</code></li><li>If C# nullable reference types are enabled, non-nullable reference types are required required.</li><li>Non-nullable value types are implicitly optional, with the exception of non-nullable foreign keys, which are required.</li></ul><p>To disable this functionality for your entire application, disable the corresponding configuration options on <code>CoalesceOptions</code>. For example, in Startup.cs or Program.cs:</p><div class="language-c#"><button title="Copy Code" class="copy"></button><span class="lang">c#</span><pre class="shiki dark-plus vp-code"><code><span class="line"><span style="color:#9CDCFE;">services</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">AddCoalesce</span><span style="color:#D4D4D4;">&lt;</span><span style="color:#4EC9B0;">AppDbContext</span><span style="color:#D4D4D4;">&gt;(</span><span style="color:#9CDCFE;">b</span><span style="color:#D4D4D4;"> =&gt; </span><span style="color:#9CDCFE;">b</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">Configure</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">o</span><span style="color:#D4D4D4;"> =&gt;</span></span>
<span class="line"><span style="color:#D4D4D4;">{</span></span>
<span class="line"><span style="color:#6A9955;">    // Set either to false to disable:</span></span>
<span class="line"><span style="color:#9CDCFE;">    o</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">ValidateAttributesForSaves</span><span style="color:#D4D4D4;"> = </span><span style="color:#569CD6;">true</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"><span style="color:#9CDCFE;">    o</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">ValidateAttributesForMethods</span><span style="color:#D4D4D4;"> = </span><span style="color:#569CD6;">true</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"><span style="color:#D4D4D4;">}));</span></span></code></pre></div><p>Each option also has a more granular override:</p><p>Enabling <code>ValidateAttributesForSaves</code> causes the <a href="/Coalesce/modeling/model-components/behaviors.html#standard-behaviors">Standard Behaviors</a> to perform validation of validation attributes during <code>/save</code> or <code>/bulkSave</code> calls, preventing a save when validation fails. This can be overridden per type or even per request by setting the <code>ValidateAttributesForSaves</code> property on a <a href="/Coalesce/modeling/model-components/behaviors.html#defining-behaviors">custom Behaviors</a> instance.</p><p>Enabling <a href="/Coalesce/modeling/model-components/attributes/execute.html#member-validateattributes"><code>ValidateAttributesForMethods</code></a> causes the generated controllers for <a href="/Coalesce/modeling/model-components/methods.html">custom methods</a> to perform validation of incoming parameters. Validation attributes may be placed on method parameters, and validation will also be performed against the members of any complex type parameters. This can be overridden per method by setting the <code>ValidateAttributes</code> property on <a href="/Coalesce/modeling/model-components/attributes/execute.html">ExecuteAttribute</a> for the method.</p><h3 id="saves-and-deletes" tabindex="-1">Saves and Deletes <a class="header-anchor" href="#saves-and-deletes" aria-label="Permalink to &quot;Saves and Deletes&quot;">​</a></h3><p>Validation of <code>/save</code>, <code>/bulkSave</code>, and <code>/delete</code> actions against <a href="/Coalesce/modeling/model-types/crud.html">CRUD Models</a> are performed by the <a href="/Coalesce/modeling/model-components/behaviors.html">Behaviors</a> for the type. Automatic <a href="#attribute-validation">attribute based validation</a> can be used (saves only), or Behaviors can be overridden to perform validation and other customization of the save and delete process, as in the following example:</p><div class="language-c#"><button title="Copy Code" class="copy"></button><span class="lang">c#</span><pre class="shiki dark-plus vp-code"><code><span class="line"><span style="color:#569CD6;">public</span><span style="color:#569CD6;"> class</span><span style="color:#4EC9B0;"> Employee</span></span>
<span class="line"><span style="color:#D4D4D4;">{</span></span>
<span class="line"><span style="color:#569CD6;">  public</span><span style="color:#569CD6;"> int</span><span style="color:#9CDCFE;"> IsCeo</span><span style="color:#D4D4D4;"> { </span><span style="color:#569CD6;">get</span><span style="color:#D4D4D4;">; </span><span style="color:#569CD6;">set</span><span style="color:#D4D4D4;">; }</span></span>
<span class="line"><span style="color:#569CD6;">  public</span><span style="color:#569CD6;"> decimal</span><span style="color:#9CDCFE;"> Salary</span><span style="color:#D4D4D4;"> { </span><span style="color:#569CD6;">get</span><span style="color:#D4D4D4;">; </span><span style="color:#569CD6;">set</span><span style="color:#D4D4D4;">; }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">  [</span><span style="color:#4EC9B0;">Coalesce</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#569CD6;">  public</span><span style="color:#569CD6;"> class</span><span style="color:#4EC9B0;"> Behaviors</span><span style="color:#D4D4D4;"> : </span><span style="color:#4EC9B0;">StandardBehaviors</span><span style="color:#D4D4D4;">&lt;</span><span style="color:#4EC9B0;">Employee</span><span style="color:#D4D4D4;">, </span><span style="color:#4EC9B0;">AppDbContext</span><span style="color:#D4D4D4;">&gt;</span></span>
<span class="line"><span style="color:#D4D4D4;">  {</span></span>
<span class="line"><span style="color:#569CD6;">    public</span><span style="color:#DCDCAA;"> Behaviors</span><span style="color:#D4D4D4;">(</span><span style="color:#4EC9B0;">CrudContext</span><span style="color:#D4D4D4;">&lt;</span><span style="color:#4EC9B0;">AppDbContext</span><span style="color:#D4D4D4;">&gt; </span><span style="color:#9CDCFE;">context</span><span style="color:#D4D4D4;">) : </span><span style="color:#569CD6;">base</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">context</span><span style="color:#D4D4D4;">) { }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6;">    public</span><span style="color:#569CD6;"> override</span><span style="color:#4EC9B0;"> ItemResult</span><span style="color:#DCDCAA;"> BeforeSave</span><span style="color:#D4D4D4;">(</span><span style="color:#4EC9B0;">SaveKind</span><span style="color:#9CDCFE;"> kind</span><span style="color:#D4D4D4;">, </span><span style="color:#4EC9B0;">Employee</span><span style="color:#D4D4D4;">? </span><span style="color:#9CDCFE;">oldItem</span><span style="color:#D4D4D4;">, </span><span style="color:#4EC9B0;">Employee</span><span style="color:#9CDCFE;"> item</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">    {</span></span>
<span class="line"><span style="color:#6A9955;">      // \`oldItem\` is a shallow copy of entity from the database,</span></span>
<span class="line"><span style="color:#6A9955;">      // and \`item\` is the tracked entity with incoming user data applied to it.</span></span>
<span class="line"><span style="color:#C586C0;">      if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">item</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">Salary</span><span style="color:#D4D4D4;"> &gt; </span><span style="color:#B5CEA8;">1_000_000m</span><span style="color:#D4D4D4;"> &amp;&amp; !</span><span style="color:#9CDCFE;">oldItem</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">IsCeo</span><span style="color:#D4D4D4;">) </span><span style="color:#C586C0;">return</span><span style="color:#CE9178;"> &quot;Salary is too high.&quot;</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"><span style="color:#C586C0;">      return</span><span style="color:#569CD6;"> true</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"><span style="color:#D4D4D4;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6;">    public</span><span style="color:#569CD6;"> override</span><span style="color:#4EC9B0;"> ItemResult</span><span style="color:#DCDCAA;"> BeforeDelete</span><span style="color:#D4D4D4;">(</span><span style="color:#4EC9B0;">Case</span><span style="color:#9CDCFE;"> item</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">    {</span></span>
<span class="line"><span style="color:#C586C0;">      if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">item</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">IsCeo</span><span style="color:#D4D4D4;">) </span><span style="color:#C586C0;">return</span><span style="color:#CE9178;"> &quot;The CEO cannot be fired.&quot;</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"><span style="color:#C586C0;">      return</span><span style="color:#569CD6;"> true</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"><span style="color:#D4D4D4;">    }</span></span>
<span class="line"><span style="color:#D4D4D4;">  }</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span></code></pre></div><h3 id="custom-methods-and-services" tabindex="-1">Custom Methods and Services <a class="header-anchor" href="#custom-methods-and-services" aria-label="Permalink to &quot;Custom Methods and Services&quot;">​</a></h3><p>For <a href="/Coalesce/modeling/model-components/methods.html">Custom Methods</a> and <a href="/Coalesce/modeling/model-types/services.html">Services</a>, you can perform your own custom validation and return errors when validation fails. You can also use <a href="#attribute-validation">attribute based validation</a>. Custom methods that need to return errors to the client are recommended to wrap their return type in an <code>ItemResult&lt;T&gt;</code>, allowing errors to be received and handled elegantly by your Coalesce Typescript code.</p><div class="language-c#"><button title="Copy Code" class="copy"></button><span class="lang">c#</span><pre class="shiki dark-plus vp-code"><code><span class="line"><span style="color:#569CD6;">public</span><span style="color:#569CD6;"> class</span><span style="color:#4EC9B0;"> Employee</span></span>
<span class="line"><span style="color:#D4D4D4;">{</span></span>
<span class="line"><span style="color:#569CD6;">  public</span><span style="color:#569CD6;"> decimal</span><span style="color:#9CDCFE;"> Salary</span><span style="color:#D4D4D4;"> { </span><span style="color:#569CD6;">get</span><span style="color:#D4D4D4;">; </span><span style="color:#569CD6;">set</span><span style="color:#D4D4D4;">; }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">  [</span><span style="color:#4EC9B0;">Coalesce</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#569CD6;">  public</span><span style="color:#4EC9B0;"> ItemResult</span><span style="color:#D4D4D4;">&lt;</span><span style="color:#569CD6;">decimal</span><span style="color:#D4D4D4;">&gt; </span><span style="color:#DCDCAA;">GiveRaise</span><span style="color:#D4D4D4;">(</span><span style="color:#569CD6;">decimal</span><span style="color:#9CDCFE;"> raiseAmount</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">  {</span></span>
<span class="line"><span style="color:#C586C0;">    if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">raiseAmount</span><span style="color:#D4D4D4;"> &gt; </span><span style="color:#B5CEA8;">3.5m</span><span style="color:#D4D4D4;">) </span><span style="color:#C586C0;">return</span><span style="color:#CE9178;"> &quot;Raises must be less than $3.50.&quot;</span></span>
<span class="line"><span style="color:#9CDCFE;">    Salary</span><span style="color:#D4D4D4;"> += </span><span style="color:#9CDCFE;">raiseAmount</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"><span style="color:#C586C0;">    return</span><span style="color:#9CDCFE;"> Salary</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"><span style="color:#D4D4D4;">  }</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span></code></pre></div><h2 id="security-overview-page" tabindex="-1">Security Overview Page <a class="header-anchor" href="#security-overview-page" aria-label="Permalink to &quot;Security Overview Page&quot;">​</a></h2><p>Coalesce provides batteries-included page that you can view to review the effective security rules in place for all the Coalesce-generated code in your project. Add this page to your application by mapping it as a route, either directly on <code>WebHost</code> in .NET 6+, or in <code>UseEndpoints</code> for 3.1+.</p><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>If you include the security overview in your production app, you should secure it with an authorization policy like in the example below. Alternatively, only map the endpoint in non-production environments.</p></div><div class="language-c#"><button title="Copy Code" class="copy"></button><span class="lang">c#</span><pre class="shiki dark-plus vp-code"><code><span class="line"><span style="color:#6A9955;">// .NET 6+ Program.cs:</span></span>
<span class="line"><span style="color:#9CDCFE;">app</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">MapCoalesceSecurityOverview</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;coalesce-security&quot;</span><span style="color:#D4D4D4;">).</span><span style="color:#DCDCAA;">RequireAuthorization</span><span style="color:#D4D4D4;">(</span></span>
<span class="line"><span style="color:#569CD6;">    new</span><span style="color:#4EC9B0;"> AuthorizeAttribute</span><span style="color:#D4D4D4;"> { </span><span style="color:#9CDCFE;">Roles</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">env</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">IsDevelopment</span><span style="color:#D4D4D4;">() ? </span><span style="color:#569CD6;">null</span><span style="color:#D4D4D4;"> : </span><span style="color:#CE9178;">&quot;Admin&quot;</span><span style="color:#D4D4D4;"> }</span></span>
<span class="line"><span style="color:#D4D4D4;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;">// .NET Core 3.1+ Startup.cs:</span></span>
<span class="line"><span style="color:#9CDCFE;">app</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">UseEndpoints</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">endpoints</span><span style="color:#D4D4D4;"> =&gt;</span></span>
<span class="line"><span style="color:#D4D4D4;">{</span></span>
<span class="line"><span style="color:#9CDCFE;">    endpoints</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">MapCoalesceSecurityOverview</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;coalesce-security&quot;</span><span style="color:#D4D4D4;">).</span><span style="color:#DCDCAA;">RequireAuthorization</span><span style="color:#D4D4D4;">(</span></span>
<span class="line"><span style="color:#569CD6;">        new</span><span style="color:#4EC9B0;"> AuthorizeAttribute</span><span style="color:#D4D4D4;"> { </span><span style="color:#9CDCFE;">Roles</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">env</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">IsDevelopment</span><span style="color:#D4D4D4;">() ? </span><span style="color:#569CD6;">null</span><span style="color:#D4D4D4;"> : </span><span style="color:#CE9178;">&quot;Admin&quot;</span><span style="color:#D4D4D4;"> }</span></span>
<span class="line"><span style="color:#D4D4D4;">    );</span></span>
<span class="line"><span style="color:#D4D4D4;">});</span></span></code></pre></div><p>Example of the contents of the security overview page: <img src="`+o+'" alt=""></p><h2 id="testing-your-security" tabindex="-1">Testing Your Security <a class="header-anchor" href="#testing-your-security" aria-label="Permalink to &quot;Testing Your Security&quot;">​</a></h2><p>If your application has complex security requirements and/or sensitive data that needs to be protected, you are encouraged to invest time into creating a set of automated tests to ensure that it is working how you expect.</p><p>The most comprehensive way to do this is to build a suite of integration tests using <a href="https://learn.microsoft.com/en-us/aspnet/core/test/integration-tests" target="_blank" rel="noreferrer">Microsoft&#39;s in-memory test server infrastructure</a>. Follow Microsoft&#39;s documentation to set up a test project, and then write tests against your API endpoints. You will want to <a href="https://learn.microsoft.com/en-us/aspnet/core/test/integration-tests#customize-webapplicationfactory" target="_blank" rel="noreferrer">substitute your Entity Framework database provider</a> with an in-memory Sqlite instance, and add a <a href="https://learn.microsoft.com/en-us/aspnet/core/test/integration-tests#mock-authentication" target="_blank" rel="noreferrer">mock authentication handler</a> to simulate authentication (we&#39;re mainly focused on testing <em>authorization</em>, not <em>authentication</em>).</p>',108),p=[t];function r(c,D,i,y,d,C){return e(),a("div",null,p)}const m=s(l,[["render",r]]);export{h as __pageData,m as default};
