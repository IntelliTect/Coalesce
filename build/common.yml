jobs:
- job: Meta

  steps:
  - pwsh: Write-Host "##vso[build.addbuildtag]$(BuildTag)"
    displayName: "Add Build Tag"

  - pwsh: >
      $path = "$(Build.Repository.LocalPath)\build\version.txt";
      Write-Host "Grabbing version from: $path";

      if(![System.IO.File]::Exists($path)){
          Write-Error "File not found!";
      }

      $version = (Get-Content $path).Trim() + "$(VersionSuffix)";
      Write-Host "Version found: $version";

      try
      {
          [System.Management.Automation.SemanticVersion]::Parse($version);
      }
      catch
      {
          Write-Error "'$version' is an invalid SemVer version"
      }

      Write-Host "##vso[task.setvariable variable=COALESCE_VERSION;isOutput=true]$version";

      $version > $(Build.ArtifactStagingDirectory)/coalesce-version.txt

      Write-Host "##vso[build.addbuildtag]$version"
    failOnStderr: true
    name: buildBaseVersion
    displayName: "Verify and set COALESCE_VERSION variable"

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Artifact: coalesce-version.txt'
    inputs:
      PathtoPublish: '$(Build.ArtifactStagingDirectory)'
      ArtifactName: coalesce-version

- job: 
  displayName: IntelliTect.Coalesce.*
  dependsOn: Meta

  variables:
    COALESCE_VERSION: $[ dependencies.Meta.outputs['buildBaseVersion.COALESCE_VERSION'] ]

  steps:
  - task: DotNetCoreInstaller@0
    displayName: 'Use .NET Core sdk 2.2.101'
    inputs:
      version: 2.2.101

  - task: NodeTool@0
    displayName: 'Use Node 10.x'
    inputs:
      versionSpec: 10.x

  - task: DotNetCoreCLI@2
    displayName: 'dotnet restore'
    inputs:
      command: restore
      projects: '**/*.csproj'

  - task: DotNetCoreCLI@2
    displayName: 'dotnet build'
    inputs:
      projects: 'src/IntelliTect.Coalesce*/*.csproj'
      arguments: '--configuration $(BuildConfiguration)'

  - task: DotNetCoreCLI@2
    displayName: 'dotnet test'
    inputs:
      command: test
      projects: 'src/IntelliTect.Coalesce*Test*/*.csproj'
      arguments: '--configuration $(BuildConfiguration)'

  - task: DotNetCoreCLI@2
    displayName: 'dotnet publish CLI'
    inputs:
      command: publish
      publishWebProjects: false
      projects: 'src/IntelliTect.Coalesce.Cli/*.csproj'
      arguments: '--configuration $(BuildConfiguration) --output $(build.artifactstagingdirectory)/dotnet-coalesce'
      zipAfterPublish: false
      modifyOutputPath: false

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Artifact: dotnet-coalesce'
    inputs:
      PathtoPublish: '$(Build.ArtifactStagingDirectory)/dotnet-coalesce'
      ArtifactName: 'dotnet-coalesce'

  - task: DotNetCoreCLI@2
    displayName: 'dotnet pack'
    inputs:
      command: pack
      packDirectory: '$(Build.ArtifactStagingDirectory)/packages'
      nobuild: true
      versioningScheme: byEnvVar
      versionEnvVar: COALESCE_VERSION

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Artifact: NuGet Packages'
    inputs:
      PathtoPublish: '$(Build.ArtifactStagingDirectory)/packages'
      ArtifactName: packages

  - script: npm ci
    displayName: 'Coalesce.Web: npm ci'
    workingDirectory: src/Coalesce.Web

  - task: DotNetCoreCLI@2
    displayName: 'Coalesce.Web: dotnet dotnet-coalesce.dll '
    inputs:
      command: custom
      custom: '$(build.artifactstagingdirectory)/dotnet-coalesce/dotnet-coalesce.dll'
      arguments: 'coalesce-ko.json'

  - script: npx gulp copyAll
    displayName: 'Coalesce.Web: npx gulp copyAll'
    workingDirectory: src/Coalesce.Web

  - script: npm run build-lib
    displayName: 'Coalesce.Web.Vue: npm run build-lib'
    workingDirectory: src/Coalesce.Web.Vue

  - script: npm ci
    displayName: 'Coalesce.Web.Vue: npm ci'
    workingDirectory: src/Coalesce.Web.Vue

  - task: DotNetCoreCLI@2
    displayName: 'Coalesce.Web.Vue: dotnet dotnet-coalesce.dll '
    inputs:
      command: custom
      custom: '$(build.artifactstagingdirectory)/dotnet-coalesce/dotnet-coalesce.dll'
      arguments: 'coalesce-vue.json'

- job:
  displayName: coalesce-vue
  dependsOn: Meta

  variables:
    COALESCE_VERSION: $[ dependencies.Meta.outputs['buildBaseVersion.COALESCE_VERSION'] ]

  steps:
  - task: NodeTool@0
    displayName: 'Use Node 10.x'
    inputs:
      versionSpec: 10.x

  - script: npm ci
    displayName: npm ci
    workingDirectory: $(CoalesceVueDir)

  - script: npm version $(COALESCE_VERSION) --no-git-tag-version
    displayName: npm version $(COALESCE_VERSION) --no-git-tag-version
    workingDirectory: $(CoalesceVueDir)

  - script: npm run build
    displayName: npm run build
    workingDirectory: $(CoalesceVueDir)

  - script: npm run test -- --coverage --reporters=default --reporters=jest-junit
    displayName: npm run test
    workingDirectory: $(CoalesceVueDir)

  - task: PublishTestResults@2
    displayName: 'Publish Test Results **/junit.xml'
    inputs:
      testResultsFiles: '**/junit.xml'
      testRunTitle: 'coalesce-vue'

  - task: geeklearningio.gl-vsts-tasks-yarn.yarn-task.Yarn@2
    displayName: 'Yarn pack'
    inputs:
      ProjectDirectory: '$(CoalesceVueDir)'
      Arguments: 'pack -f $(Build.ArtifactStagingDirectory)/coalesce-vue.tgz'

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Artifact: coalesce-vue'
    inputs:
      ArtifactName: 'coalesce-vue'
